<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>胡一刀的个人博客</title>
  
  <subtitle>May the force be with you</subtitle>
  <link href="https://sonnyhcl.com/atom.xml" rel="self"/>
  
  <link href="https://sonnyhcl.com/"/>
  <updated>2022-01-03T03:31:30.000Z</updated>
  <id>https://sonnyhcl.com/</id>
  
  <author>
    <name>sonnyhcl</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Test Driven Delelop</title>
    <link href="https://sonnyhcl.com/test-driven-develop/"/>
    <id>https://sonnyhcl.com/test-driven-develop/</id>
    <published>2022-01-03T03:31:30.000Z</published>
    <updated>2022-01-03T03:31:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>“测试驱动开发”是一个比较有意思的软件工程上的概念，一直都想找个机会看看。刚好最近在重构工作中用到的 CI/CD + Test Infra，所以借此机会来看一下《测试驱动开发》这本书。</p><span id="more"></span><p>这本书分成三个大模块，前两个模块可以跳过，直接来到第三模块：测试驱动开发的模式。</p><h2 id="测试驱动开发的模式"><a href="#测试驱动开发的模式" class="headerlink" title="测试驱动开发的模式"></a>测试驱动开发的模式</h2><ul><li><ol start="25"><li>测试驱动开发模式</li></ol><ul><li>相互独立的测试<ul><li>测试尽可能快</li><li>如果有两个测试失败了，应该是不同的两个问题，而不是环境问题</li></ul></li><li>先写测试</li><li>先写断言</li><li>编写测试数据<ul><li>mock data 尽量简单直观，使用常量字符串表明含义</li><li>真实数据要有实用场景支撑</li></ul></li></ul></li><li><ol start="26"><li>不可运行状态模式</li></ol><ul><li>启动测试<ul><li>选择尽量简单的测试目标作为第一步</li></ul></li></ul></li><li><ol start="27"><li>测试规范</li></ol><ul><li>拆分较大的测试</li><li>对于昂贵/复杂（时间/金钱意义上）的测试对象，采用 Mock 的方式进行测试<ul><li>risk: 保证 mock object 与实际对象的行为一致</li></ul></li></ul></li><li><ol start="28"><li>可运行模式</li></ol><ul><li>失败的测试比不能运行的测试要好<ul><li>example: 不能运行的测试有时候甚至会从测试报告中遗漏</li></ul></li><li>利用测试推动抽象：当你有两个以上的例子时候才能进行进一步抽象</li></ul></li><li><ol start="30"><li>设计模式</li></ol><ul><li>常用的设计模式同样对编写测试代码有指导作用</li></ul></li><li><ol start="32"><li>掌握 TDD</li></ol><ul><li>Smell: 过长或者冗余的对象初始化脚手架代码，过长的测试运行时间，测试经常 transient 地失败</li><li>需要编写多少测试：考虑平均无故障时间，不必要为用不着的极限情况写测试</li><li>如何中途转向 TDD：不推荐直接完全重构。的确是比较困难。</li></ul></li></ul><p>整本书读下来的整体感觉还是过于 high level 了，希望以后能常读常新吧。</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;“测试驱动开发”是一个比较有意思的软件工程上的概念，一直都想找个机会看看。刚好最近在重构工作中用到的 CI/CD + Test Infra，所以借此机会来看一下《测试驱动开发》这本书。&lt;/p&gt;</summary>
    
    
    
    <category term="Reading" scheme="https://sonnyhcl.com/categories/Reading/"/>
    
    
    <category term="test-driven-develop" scheme="https://sonnyhcl.com/tags/test-driven-develop/"/>
    
  </entry>
  
  <entry>
    <title>Certificated Kubernetes Application Developer</title>
    <link href="https://sonnyhcl.com/ckad/"/>
    <id>https://sonnyhcl.com/ckad/</id>
    <published>2021-12-29T03:10:54.000Z</published>
    <updated>2021-12-29T03:10:54.000Z</updated>
    
    <content type="html"><![CDATA[<p>分享一下之前准备 CKAD 考试的一些资料</p><span id="more"></span><h2 id="What’s-CKAD"><a href="#What’s-CKAD" class="headerlink" title="What’s CKAD"></a>What’s CKAD</h2><p>The Certified Kubernetes Application Developer (CKAD) program has been developed by the Cloud Native Computing Foundation (CNCF), in collaboration with The Linux Foundation, to help expand the Kubernetes ecosystem through standardized training and certification.</p><blockquote><p>From <a href="https://www.cncf.io/certification/ckad/">https://www.cncf.io/certification/ckad/</a></p></blockquote><p>The Certified Kubernetes Application Developer exam certifies that users can design, build, configure, and expose cloud native applications for Kubernetes.</p><blockquote><p>From <a href="https://www.cncf.io/certification/ckad/">https://www.cncf.io/certification/ckad/</a></p></blockquote><h2 id="Curriculum"><a href="#Curriculum" class="headerlink" title="Curriculum"></a>Curriculum</h2><p><a href="https://github.com/cncf/curriculum">https://github.com/cncf/curriculum</a></p><h2 id="Free-resources-for-CKAD-and-Kubernetes"><a href="#Free-resources-for-CKAD-and-Kubernetes" class="headerlink" title="Free resources for CKAD and Kubernetes"></a>Free resources for CKAD and Kubernetes</h2><ul><li><p>K8s provider </p><ul><li>AKS: <a href="https://ms.portal.azure.com/">https://ms.portal.azure.com/</a> </li><li>Minikube: <a href="https://minikube.sigs.k8s.io/docs/start/">https://minikube.sigs.k8s.io/docs/start/</a></li></ul></li><li><p>Kubernetes official doc</p><blockquote><p>only website you can visit during exam</p></blockquote><ul><li>Kubectl Command: <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#run">https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#run</a><br>○ <a href="https://v1-21.docs.kubernetes.io/docs/reference/generated/kubectl/kubectl-commands">https://v1-21.docs.kubernetes.io/docs/reference/generated/kubectl/kubectl-commands</a><ul><li>Kubectl Doc: <a href="https://kubernetes.io/docs/concepts/">https://kubernetes.io/docs/concepts/</a></li></ul></li></ul></li><li><p>Book on Kubernetes Knowledge</p><ul><li>Kubernetes in Action: <a href="https://learning.oreilly.com/library/view/kubernetes-in-action/9781617293726/">https://learning.oreilly.com/library/view/kubernetes-in-action/9781617293726/</a></li><li>Kubernetes Pattern: <a href="https://learning.oreilly.com/library/view/kubernetes-patterns/9781492050278/">https://learning.oreilly.com/library/view/kubernetes-patterns/9781492050278/</a></li></ul></li><li><p>CKAD Self Practice questions:</p><ul><li><a href="https://github.com/dgkanatsios/CKAD-exercises">https://github.com/dgkanatsios/CKAD-exercises</a></li><li><a href="https://github.com/bbachi/CKAD-Practice-Questions">https://github.com/bbachi/CKAD-Practice-Questions</a></li><li><a href="https://github.com/bmuschko/ckad-prep">https://github.com/bmuschko/ckad-prep</a></li></ul></li><li><p>CKAD Interactive Practice</p><ul><li><a href="https://www.katacoda.com/liptanbiswas/courses/ckad-practice-challenges/core-concepts">https://www.katacoda.com/liptanbiswas/courses/ckad-practice-challenges/core-concepts</a></li><li><a href="https://learning.oreilly.com/playlists/8aa87dce-f9a9-4206-83af-c8c730faa430/">https://learning.oreilly.com/playlists/8aa87dce-f9a9-4206-83af-c8c730faa430/</a></li><li><a href="https://killer.sh/ckad">https://killer.sh/ckad</a> (2 free session after you register CKAD exam)</li></ul></li><li><p>CKAD Training Video</p><ul><li><a href="https://app.pluralsight.com/paths/certificate/certified-kubernetes-application-developer-ckad">https://app.pluralsight.com/paths/certificate/certified-kubernetes-application-developer-ckad</a></li><li><a href="https://training.linuxfoundation.org/training/introduction-to-kubernetes/">https://training.linuxfoundation.org/training/introduction-to-kubernetes/</a></li><li><a href="https://learning.oreilly.com/learning-paths/learning-path-certified/9781492061021/">https://learning.oreilly.com/learning-paths/learning-path-certified/9781492061021/</a></li></ul></li></ul><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;分享一下之前准备 CKAD 考试的一些资料&lt;/p&gt;</summary>
    
    
    
    <category term="Tech" scheme="https://sonnyhcl.com/categories/Tech/"/>
    
    
    <category term="Tech" scheme="https://sonnyhcl.com/tags/Tech/"/>
    
    <category term="CKAD" scheme="https://sonnyhcl.com/tags/CKAD/"/>
    
    <category term="Kubernetes" scheme="https://sonnyhcl.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>使用GitHub Action自动生成Hexo个人博客</title>
    <link href="https://sonnyhcl.com/hexo-blog-with-github-action/"/>
    <id>https://sonnyhcl.com/hexo-blog-with-github-action/</id>
    <published>2021-05-09T11:31:08.000Z</published>
    <updated>2021-05-09T11:31:08.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近发现<code>.top</code>的域名经常会被各种不友好防火墙封杀（比如公司网络），就给博客换了个新的域名<a href="https://sonnyhcl.com/"><code>sonnyhcl.com</code></a>。</p><p>博客之前是基于 GitHub Pages+Hexo+Next Mist+Travis CI 搭建的，详情请参考这篇博客 <a href="/hexo-github-page-blog/" title="Hexo+GitHub 搭建个人博客">Hexo+GitHub 搭建个人博客</a>。<br>正巧发现 Travis CI 已经被 deprecated 不能正常工作了，就想着尝鲜用 GitHub Action 来做自动集成。</p><span id="more"></span><h2 id="GitHub-Action-定义"><a href="#GitHub-Action-定义" class="headerlink" title="GitHub Action 定义"></a>GitHub Action 定义</h2><p>GitHub Action 的文件定义在<code>.github/workflows</code>文件夹下，每个 yaml 文件存着对应的 GitHub Action 的定义，当然本质上它就是一层套了壳的 Azure Pipeline，所以看起来会跟 Azure Pipeline 极度相似。如下所示是本博客所使用的 GitHub Action 定义。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">CI</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> [<span class="string">source</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">GIT_USER:</span> <span class="string">&quot;&quot;</span> <span class="comment"># Your display name</span></span><br><span class="line">  <span class="attr">GIT_EMAIL:</span> <span class="string">&quot;&quot;</span> <span class="comment"># Your git email address</span></span><br><span class="line">  <span class="attr">DEPLOY_REPO:</span> <span class="string">&quot;&quot;</span> <span class="comment"># Your repo</span></span><br><span class="line">  <span class="attr">DEPLOY_BRANCH:</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">pages:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">source</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="string">source</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">Node.js</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v2.1.5</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Cache</span> <span class="string">NPM</span> <span class="string">dependencies</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/cache@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">node_modules</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">$&#123;&#123;</span> <span class="string">runner.OS</span> <span class="string">&#125;&#125;-npm-cache</span></span><br><span class="line">          <span class="attr">restore-keys:</span> <span class="string">|</span></span><br><span class="line">            <span class="string">$&#123;&#123;</span> <span class="string">runner.OS</span> <span class="string">&#125;&#125;-npm-cache</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Dependencies</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">peaceiris/actions-gh-pages@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">github_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">publish_dir:</span> <span class="string">./public</span></span><br><span class="line">          <span class="attr">publish_branch:</span> <span class="string">master</span> <span class="comment"># deploying branch</span></span><br></pre></td></tr></table></figure><p>定义好 GitHub Action 之后，每次 source 分支有新的 commit，都会自动触发 GitHub Action 对 source 分支进行一次新的 build，并把 build 好的静态文件内容发布到 master 分支上去，整个过程大约在 30s 左右完成，随后就可以看到我挂在 GitHub Pages 上的博客网站已经自动更新了。</p><p><img src="github_action.png" alt="GitHub Action"></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;最近发现&lt;code&gt;.top&lt;/code&gt;的域名经常会被各种不友好防火墙封杀（比如公司网络），就给博客换了个新的域名&lt;a href=&quot;https://sonnyhcl.com/&quot;&gt;&lt;code&gt;sonnyhcl.com&lt;/code&gt;&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;博客之前是基于 GitHub Pages+Hexo+Next Mist+Travis CI 搭建的，详情请参考这篇博客 &lt;a href=&quot;/hexo-github-page-blog/&quot; title=&quot;Hexo+GitHub 搭建个人博客&quot;&gt;Hexo+GitHub 搭建个人博客&lt;/a&gt;。&lt;br&gt;正巧发现 Travis CI 已经被 deprecated 不能正常工作了，就想着尝鲜用 GitHub Action 来做自动集成。&lt;/p&gt;</summary>
    
    
    
    <category term="Tech" scheme="https://sonnyhcl.com/categories/Tech/"/>
    
    
    <category term="Hexo" scheme="https://sonnyhcl.com/tags/Hexo/"/>
    
    <category term="Next" scheme="https://sonnyhcl.com/tags/Next/"/>
    
    <category term="Mist" scheme="https://sonnyhcl.com/tags/Mist/"/>
    
    <category term="Github Action" scheme="https://sonnyhcl.com/tags/Github-Action/"/>
    
  </entry>
  
  <entry>
    <title>搭建本地私有云之集成LDAP+Office+Transmission的NextCloud</title>
    <link href="https://sonnyhcl.com/on-premise-nextcloud-with-ldap-and-office-and-transmission/"/>
    <id>https://sonnyhcl.com/on-premise-nextcloud-with-ldap-and-office-and-transmission/</id>
    <published>2019-10-17T05:30:41.000Z</published>
    <updated>2019-10-17T05:30:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>这个系列是笔者在为实验室搭建本地私有云的过程中所记载的笔记,看起来会比较杂乱 :)</p><p>NextCloud可以用来搭建个人网盘,同时还可以纳入LDAP认证进行统一的用户管理.在此基础之上为了进一步增添办公属性,我们还为它集成了onlyoffice办公套件的支持以及transmission下载套件的支持.</p><span id="more"></span><p>首先我们需要一台崭新的ubuntu18.04的虚拟机,虚拟机的初始化配置此处不再赘述.我们为该虚拟机新增一块500GB的数据盘用作数据存储.</p><h2 id="搭建nextcloud服务"><a href="#搭建nextcloud服务" class="headerlink" title="搭建nextcloud服务"></a>搭建nextcloud服务</h2><h3 id="挂载数据盘"><a href="#挂载数据盘" class="headerlink" title="挂载数据盘"></a>挂载数据盘</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo mkfs.ext4 <span class="regexp">/dev/</span>vdb</span><br><span class="line">echo <span class="string">&quot;/dev/vdb/srvext4defaults 00&quot;</span> | sudo tee -a <span class="regexp">/etc/</span>fstab</span><br><span class="line">sudo mount <span class="regexp">/dev/</span>vdb /srv</span><br><span class="line">sudo chown -R oem:oem /srv</span><br><span class="line">lsblk</span><br></pre></td></tr></table></figure><h3 id="安装docker和docker-compose"><a href="#安装docker和docker-compose" class="headerlink" title="安装docker和docker-compose"></a>安装docker和docker-compose</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install docker.io docker-compose</span><br><span class="line">sudo usermod -aG docker oem</span><br><span class="line">sudo systemctl <span class="builtin-name">enable</span> docker</span><br></pre></td></tr></table></figure><h3 id="准备db-env和docker-compose-yml"><a href="#准备db-env和docker-compose-yml" class="headerlink" title="准备db.env和docker-compose.yml"></a>准备db.env和docker-compose.yml</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkdir /srv/compose</span><br><span class="line">cd /srv/compose</span><br><span class="line">oem@nextcloud:/srv/compose$ tree -L <span class="number">2</span></span><br><span class="line">.</span><br><span class="line">├── certs</span><br><span class="line">│   ├── nextcloud<span class="selector-class">.sonnyhcl</span><span class="selector-class">.top</span>.crt</span><br><span class="line">│   └── nextcloud<span class="selector-class">.sonnyhcl</span><span class="selector-class">.top</span>.key</span><br><span class="line">├── db.env</span><br><span class="line">└── docker-compose.yml</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">4</span> files</span><br></pre></td></tr></table></figure><h3 id="srv-compose-db-env"><a href="#srv-compose-db-env" class="headerlink" title="/srv/compose/db.env"></a><code>/srv/compose/db.env</code></h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">MYSQL_PASSWORD</span>=nextcloud</span><br><span class="line"><span class="attr">MYSQL_DATABASE</span>=nextcloud</span><br><span class="line"><span class="attr">MYSQL_USER</span>=nextcloud</span><br></pre></td></tr></table></figure><h3 id="srv-compose-docker-compose-yml"><a href="#srv-compose-docker-compose-yml" class="headerlink" title="/srv/compose/docker-compose.yml"></a><code>/srv/compose/docker-compose.yml</code></h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">services:</span></span><br><span class="line"><span class="symbol">  db:</span></span><br><span class="line"><span class="symbol">    image:</span> mariadb</span><br><span class="line"><span class="symbol">    restart:</span> unless-stopped</span><br><span class="line"><span class="symbol">    container_name:</span> mariadb</span><br><span class="line"><span class="symbol">    command:</span> --transaction-isolation=READ-COMMITTED --binlog-format=ROW</span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - <span class="meta-keyword">/srv/</span>db:<span class="meta-keyword">/var/</span>lib/mysql</span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line">      - MYSQL_ROOT_PASSWORD=nextcloud</span><br><span class="line"><span class="symbol">    env_file:</span></span><br><span class="line">      - db.env</span><br><span class="line"></span><br><span class="line"><span class="symbol">  nextcloud:</span></span><br><span class="line"><span class="symbol">    image:</span> nextcloud</span><br><span class="line"><span class="symbol">    restart:</span> unless-stopped</span><br><span class="line"><span class="symbol">    container_name:</span> nextcloud</span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">      - NEXTCLOUD_ADMIN_USER=oem            </span><br><span class="line">      - NEXTCLOUD_ADMIN_PASSWORD=oem</span><br><span class="line">      - NEXTCLOUD_TRUSTED_DOMAINS=nextcloud.sonnyhcl.top</span><br><span class="line">      - MYSQL_HOST=db</span><br><span class="line">      - VIRTUAL_HOST=nextcloud.sonnyhcl.top</span><br><span class="line"><span class="symbol">    env_file:</span></span><br><span class="line">      - db.env</span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - <span class="meta-keyword">/srv/</span>nextcloud:<span class="meta-keyword">/var/</span>www/html</span><br><span class="line"><span class="symbol">    depends_on:</span></span><br><span class="line">      - db</span><br><span class="line"></span><br><span class="line"><span class="symbol">  nginx:</span></span><br><span class="line"><span class="symbol">    image:</span> jwilder/nginx-proxy</span><br><span class="line"><span class="symbol">    restart:</span> unless-stopped</span><br><span class="line"><span class="symbol">    container_name:</span> nginx</span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line">      - VIRTUAL_PROTO=https</span><br><span class="line">      - VIRTUAL_PORT=<span class="number">443</span></span><br><span class="line"><span class="symbol">    ports:</span></span><br><span class="line">      - <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      - <span class="string">&quot;443:443&quot;</span></span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - <span class="meta-keyword">/var/</span>run/docker.sock:<span class="meta-keyword">/tmp/</span>docker.sock:ro</span><br><span class="line">      - ./certs:<span class="meta-keyword">/etc/</span>nginx/certs</span><br></pre></td></tr></table></figure><h3 id="启动nextcloud服务"><a href="#启动nextcloud服务" class="headerlink" title="启动nextcloud服务"></a>启动nextcloud服务</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker-compose up -d</span></span><br></pre></td></tr></table></figure><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="https://github.com/jwilder/nginx-proxy#ssl-backends">nginx ssl</a></li><li><a href="https://github.com/nextcloud/docker/blob/master/.examples/docker-compose/with-nginx-proxy-self-signed-ssl/mariadb/fpm/docker-compose.yml">nextcloud docker-compose example</a></li></ul><h2 id="整合Nextcloud与LDAP-AD"><a href="#整合Nextcloud与LDAP-AD" class="headerlink" title="整合Nextcloud与LDAP/AD"></a>整合Nextcloud与LDAP/AD</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ul><li>登录<code>https://nextcloud.sonnyhcl.top</code></li><li>选择启动LDAP插件</li><li>进入 设置页面 -&gt; LDAP/AD整合</li></ul><h3 id="配置LDAP"><a href="#配置LDAP" class="headerlink" title="配置LDAP"></a>配置LDAP</h3><h4 id="服务器标签页"><a href="#服务器标签页" class="headerlink" title="服务器标签页"></a>服务器标签页</h4><p>这里用admin账号应该不是best practice </p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Server:</span> ldap:<span class="comment">//ipa.sonnyhcl.top</span></span><br><span class="line"><span class="symbol">Port:</span> <span class="number">389</span></span><br><span class="line">User DN: uid=admin,cn=users,cn=accounts,dc=sonnyhcl,dc=top</span><br><span class="line"><span class="symbol">Password:</span> xxx</span><br><span class="line"><span class="symbol">BaseCN:</span> dc=sonnyhcl,dc=top</span><br></pre></td></tr></table></figure><h4 id="用户标签页"><a href="#用户标签页" class="headerlink" title="用户标签页"></a>用户标签页</h4><p>手动编辑LDAP查询</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">Edit</span><span class="built_in"> raw filter </span>instead: (<span class="attribute">objectclass</span>=*)</span><br></pre></td></tr></table></figure><p>验证设置和统计用户应该能发现若干个用户</p><h4 id="登录属性标签页"><a href="#登录属性标签页" class="headerlink" title="登录属性标签页"></a>登录属性标签页</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LDAP Username: checked</span><br><span class="line"><span class="builtin-name">Edit</span><span class="built_in"> raw filter </span>instead: (&amp;(<span class="attribute">objectclass</span>=*)(uid=%uid))</span><br></pre></td></tr></table></figure><ul><li>验证设置，输入clhu返回找到用户</li></ul><h4 id="群组标签页"><a href="#群组标签页" class="headerlink" title="群组标签页"></a>群组标签页</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">Edit</span><span class="built_in"> raw filter </span>instead: (|(<span class="attribute">cn</span>=ipausers))</span><br></pre></td></tr></table></figure><ul><li>验证设置和统计分组数应该返回1</li></ul><h4 id="高级标签页"><a href="#高级标签页" class="headerlink" title="高级标签页"></a>高级标签页</h4><h5 id="连接设置"><a href="#连接设置" class="headerlink" title="连接设置"></a>连接设置</h5><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Configuration Active</span>: checked</span><br></pre></td></tr></table></figure><h5 id="目录设置"><a href="#目录设置" class="headerlink" title="目录设置"></a>目录设置</h5><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">User</span> <span class="title">Display</span> Name Field: displayname</span><br><span class="line">Base <span class="keyword">User</span> <span class="title">Tree</span>: <span class="attr">cn=</span>users,<span class="attr">cn=</span>accounts,<span class="attr">dc=</span>sonnyhcl,<span class="attr">dc=</span>top</span><br><span class="line"><span class="keyword">Group</span> <span class="title">Display</span> Name Field: cn</span><br><span class="line">Base <span class="keyword">Group</span> <span class="title">Tree</span>: <span class="attr">cn=</span>groups,<span class="attr">cn=</span>accounts,<span class="attr">dc=</span>sonnyhcl,<span class="attr">dc=</span>top</span><br><span class="line">Group-Member association: uniqueMember</span><br><span class="line">Paging chunksize: <span class="number">500</span></span><br></pre></td></tr></table></figure><h5 id="特殊属性"><a href="#特殊属性" class="headerlink" title="特殊属性"></a>特殊属性</h5><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Email Field: mail</span><br><span class="line"><span class="keyword">User</span> <span class="title">Home</span> Folder Naming <span class="keyword">Rule</span>: cn</span><br></pre></td></tr></table></figure><h4 id="专家标签页"><a href="#专家标签页" class="headerlink" title="专家标签页"></a>专家标签页</h4><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Internal Username Attrbute</span>: uid</span><br></pre></td></tr></table></figure><h3 id="参考链接-1"><a href="#参考链接-1" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="https://www.freeipa.org/page/Owncloud_Authentication_against_FreeIPA">Owncloud_Authentication_against_FreeIPA</a></li></ul><h2 id="使用Transmission实现PT下载"><a href="#使用Transmission实现PT下载" class="headerlink" title="使用Transmission实现PT下载"></a>使用Transmission实现PT下载</h2><h3 id="安装transmission"><a href="#安装transmission" class="headerlink" title="安装transmission"></a>安装transmission</h3><h4 id="安装包"><a href="#安装包" class="headerlink" title="安装包"></a>安装包</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt <span class="keyword">install</span> transmission-daemon -y</span><br></pre></td></tr></table></figure><h4 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h4><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 必须先暂停daemon才能修改配置文件，否则分分钟被daemon覆写</span></span><br><span class="line">sudo service transmission-daemon stop</span><br><span class="line">sudo vim /etc/transmission-daemon/settings.json</span><br><span class="line">-------------------</span><br><span class="line"><span class="meta">#更改以下参数的值</span></span><br><span class="line"><span class="meta">#默认下载位置</span></span><br><span class="line"><span class="string">&quot;download-dir&quot;</span>: <span class="string">&quot;/srv/downloads&quot;</span></span><br><span class="line"><span class="meta">#替换为远程连接的用户名和密码</span></span><br><span class="line"><span class="string">&quot;rpc-password&quot;</span>:<span class="string">&quot;nextcloud&quot;</span></span><br><span class="line"><span class="string">&quot;rpc-username&quot;</span>: <span class="string">&quot;nextcloud&quot;</span></span><br><span class="line"><span class="meta">#关闭远程连接白名单</span></span><br><span class="line"><span class="string">&quot;rpc-whitelist-enabled&quot;</span>: <span class="literal">false</span></span><br><span class="line"><span class="meta">#限速20M/s</span></span><br><span class="line"><span class="string">&quot;speed-limit-down&quot;</span>: <span class="number">20000</span></span><br><span class="line"><span class="string">&quot;speed-limit-down-enabled&quot;</span>: <span class="literal">true</span></span><br><span class="line">-------------------</span><br><span class="line">sudo service transmission-daemon start</span><br></pre></td></tr></table></figure><h4 id="打开ip-port，输入用户名密码访问web下载页面"><a href="#打开ip-port，输入用户名密码访问web下载页面" class="headerlink" title="打开ip:port，输入用户名密码访问web下载页面"></a>打开<code>ip:port</code>，输入用户名密码访问web下载页面</h4><h3 id="在Nextcloud中集成"><a href="#在Nextcloud中集成" class="headerlink" title="在Nextcloud中集成"></a>在Nextcloud中集成</h3><ul><li>修改nextcloud的挂载配置<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">oem<span class="variable">@nextcloud</span><span class="symbol">:/srv/compose</span><span class="variable">$ </span>git diff</span><br><span class="line">diff --git a/docker-compose.yml b/docker-compose.yml</span><br><span class="line">index b32cab0..<span class="number">6380</span>ee8 <span class="number">100644</span></span><br><span class="line">--- a/docker-compose.yml</span><br><span class="line">+++ b/docker-compose.yml</span><br><span class="line">@@ <span class="number">-28</span>,<span class="number">6</span> +<span class="number">28</span>,<span class="number">7</span> @@ <span class="symbol">services:</span></span><br><span class="line">       - db.env</span><br><span class="line">     <span class="symbol">volumes:</span></span><br><span class="line">       - <span class="regexp">/srv/nextcloud</span><span class="symbol">:/var/www/html</span></span><br><span class="line">+      - <span class="regexp">/srv/downloads</span><span class="symbol">:/downloads</span></span><br><span class="line">     <span class="symbol">depends_on:</span></span><br><span class="line">       - db</span><br></pre></td></tr></table></figure></li><li>启用<code>External Storage Support</code>应用</li><li>点击设置-&gt;外部存储</li><li>目录名称：Transmission 外部存储：本地 配置：/downloads 可用于：选择用户</li></ul><h2 id="集成OnlyOffice在线协作编辑"><a href="#集成OnlyOffice在线协作编辑" class="headerlink" title="集成OnlyOffice在线协作编辑"></a>集成OnlyOffice在线协作编辑</h2><h3 id="重复利用nextcloud-sonnyhcl-top的ssl证书"><a href="#重复利用nextcloud-sonnyhcl-top的ssl证书" class="headerlink" title="重复利用nextcloud.sonnyhcl.top的ssl证书"></a>重复利用nextcloud.sonnyhcl.top的ssl证书</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clhu<span class="variable">@nextcloud</span><span class="symbol">:/srv/onlyoffice/data/certs</span><span class="variable">$ </span>ls</span><br><span class="line">onlyoffice.crt  onlyoffice.key</span><br></pre></td></tr></table></figure><h3 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">clhu@nextcloud:<span class="regexp">/srv/</span>compose/onlyoffice$ cat docker-compose.yml </span><br><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  web:</span><br><span class="line">    image: onlyoffice/documentserver</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    container_name: onlyoffice</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="regexp">/srv/</span>onlyoffice<span class="regexp">/data:/</span>var<span class="regexp">/www/</span>onlyoffice/Data</span><br><span class="line">      - <span class="regexp">/srv/</span>onlyoffice<span class="regexp">/logs:/</span>var<span class="regexp">/log/</span>onlyoffice</span><br><span class="line">      - <span class="regexp">/srv/</span>onlyoffice<span class="regexp">/lib:/</span>var<span class="regexp">/lib/</span>onlyoffice</span><br><span class="line">      - <span class="regexp">/srv/</span>onlyoffice<span class="regexp">/db:/</span>var<span class="regexp">/lib/</span>postgresql</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;8080:80&quot;</span></span><br><span class="line">      - <span class="string">&quot;8443:443&quot;</span></span><br></pre></td></tr></table></figure><h3 id="运行onlyoffice"><a href="#运行onlyoffice" class="headerlink" title="运行onlyoffice"></a>运行onlyoffice</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clhu<span class="variable">@nextcloud</span><span class="symbol">:/srv/compose/onlyoffice</span><span class="variable">$ </span>docker-compose up -d</span><br></pre></td></tr></table></figure><h3 id="在nextcloud中配置onlyoffice"><a href="#在nextcloud中配置onlyoffice" class="headerlink" title="在nextcloud中配置onlyoffice"></a>在nextcloud中配置onlyoffice</h3><ul><li>在应用中启用OnlyOffice</li><li>设置中选择OnlyOffice-&gt;填写域名 <a href="https://nextcloud.sonnyhcl.top:8443/">https://nextcloud.sonnyhcl.top:8443</a></li></ul><h3 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h3><ul><li>transmission-daemon用的是debian-transmission这个用户，而nextcloud用的是www-data这个用户，对downloads文件夹只有只读权限</li><li>视频在线播放没有声音,视频格式的兼容性较差</li></ul><h3 id="参考链接-2"><a href="#参考链接-2" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="https://www.jianshu.com/p/044de40f7a32">NextCloud + Transmission 实现 PT下载机以及在线播放</a></li></ul><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;这个系列是笔者在为实验室搭建本地私有云的过程中所记载的笔记,看起来会比较杂乱 :)&lt;/p&gt;
&lt;p&gt;NextCloud可以用来搭建个人网盘,同时还可以纳入LDAP认证进行统一的用户管理.在此基础之上为了进一步增添办公属性,我们还为它集成了onlyoffice办公套件的支持以及transmission下载套件的支持.&lt;/p&gt;</summary>
    
    
    
    <category term="Tech" scheme="https://sonnyhcl.com/categories/Tech/"/>
    
    
    <category term="on-premise-cloud" scheme="https://sonnyhcl.com/tags/on-premise-cloud/"/>
    
    <category term="NextCloud" scheme="https://sonnyhcl.com/tags/NextCloud/"/>
    
    <category term="onlyoffice" scheme="https://sonnyhcl.com/tags/onlyoffice/"/>
    
    <category term="transmission" scheme="https://sonnyhcl.com/tags/transmission/"/>
    
  </entry>
  
  <entry>
    <title>搭建本地私有云之集成LDAP的GitLab</title>
    <link href="https://sonnyhcl.com/on-premise-gitlab-with-ldap/"/>
    <id>https://sonnyhcl.com/on-premise-gitlab-with-ldap/</id>
    <published>2019-10-17T05:09:01.000Z</published>
    <updated>2019-10-17T05:09:01.000Z</updated>
    
    <content type="html"><![CDATA[<p>这个系列是笔者在为实验室搭建本地私有云的过程中所记载的笔记,看起来会比较杂乱 :)</p><p>本文介绍在本地搭建自己的gitlab服务,并集成FreeIPA提供的LDAP认证</p><span id="more"></span><p>首先我们需要一台崭新的ubuntu18.04的虚拟机,虚拟机的初始化配置此处不再赘述.我们为该虚拟机新增一块500GB的数据盘用作数据存储.</p><h2 id="搭建gitlab服务"><a href="#搭建gitlab服务" class="headerlink" title="搭建gitlab服务"></a>搭建gitlab服务</h2><h3 id="挂载数据盘"><a href="#挂载数据盘" class="headerlink" title="挂载数据盘"></a>挂载数据盘</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo mkfs.ext4 <span class="regexp">/dev/</span>vdb</span><br><span class="line">echo <span class="string">&quot;/dev/vdb/srvext4defaults 00&quot;</span> | sudo tee -a <span class="regexp">/etc/</span>fstab</span><br><span class="line">sudo mount <span class="regexp">/dev/</span>vdb /srv</span><br><span class="line">sudo chown -R oem:oem /srv <span class="comment"># oem可以替换成你的用户名</span></span><br><span class="line">lsblk</span><br></pre></td></tr></table></figure><h3 id="安装docker和docker-compose"><a href="#安装docker和docker-compose" class="headerlink" title="安装docker和docker-compose"></a>安装docker和docker-compose</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install docker.io docker-compose</span><br><span class="line">sudo usermod -aG docker oem</span><br><span class="line">sudo systemctl <span class="builtin-name">enable</span> docker</span><br></pre></td></tr></table></figure><h3 id="添加LDAP认证用户"><a href="#添加LDAP认证用户" class="headerlink" title="添加LDAP认证用户"></a>添加LDAP认证用户</h3><p>在FreeIPA中添加GitLab用户,在gitlab.rb中配置为LDAP认证用户使用</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">login:</span> gitlab</span><br><span class="line"><span class="symbol">FirstName:</span> GitLab</span><br><span class="line"><span class="symbol">LastName:</span> Bind User</span><br><span class="line"><span class="symbol">Password:</span> gitlab</span><br></pre></td></tr></table></figure><h3 id="配置gitlab-rb"><a href="#配置gitlab-rb" class="headerlink" title="配置gitlab.rb"></a>配置gitlab.rb</h3><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">clhu@gitlab-old:/srv/gitlab/config$ sudo cat gitlab.rb | egrep -v <span class="string">&quot;^#|^$&quot;</span></span><br><span class="line">external_url <span class="string">&quot;https://gitlab.sonnyhcl.top&quot;</span></span><br><span class="line">nginx[<span class="string">&#x27;redirect_http_to_https&#x27;</span>] = true</span><br><span class="line">nginx[<span class="string">&#x27;ssl_certificate&#x27;</span>] = <span class="string">&quot;/etc/gitlab/ssl/gitlab.sonnyhcl.top.pem&quot;</span></span><br><span class="line">nginx[<span class="string">&#x27;ssl_certificate_key&#x27;</span>] = <span class="string">&quot;/etc/gitlab/ssl/gitlab.sonnyhcl.top.key&quot;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;time_zone&#x27;</span>] = <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_enable&#x27;</span>] = true</span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_address&#x27;</span>] = <span class="string">&quot;smtp.163.com&quot;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_port&#x27;</span>] = <span class="number">25</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_user_name&#x27;</span>] = <span class="string">&quot;xxx@163.com&quot;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_password&#x27;</span>] = <span class="string">&quot;xxx&quot;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_domain&#x27;</span>] = <span class="string">&quot;163.com&quot;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_authentication&#x27;</span>] = :login</span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_enable_starttls_auto&#x27;</span>] = true</span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_email_reply_to&#x27;</span>] = <span class="string">&#x27;noreply@163.com&#x27;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_email_from&#x27;</span>] = <span class="string">&quot;xxx@163.com&quot;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;ldap_enabled&#x27;</span>] = true</span><br><span class="line">gitlab_rails[<span class="string">&#x27;ldap_servers&#x27;</span>] = <span class="symbol">YAML</span>.load &lt;&lt;-<span class="string">&#x27;EOS&#x27;</span></span><br><span class="line">main:</span><br><span class="line">  label: <span class="string">&#x27;LDAP&#x27;</span></span><br><span class="line">  host: <span class="string">&#x27;ipa.sonnyhcl.top&#x27;</span></span><br><span class="line">  port: <span class="number">389</span></span><br><span class="line">  uid: <span class="string">&#x27;uid&#x27;</span></span><br><span class="line">  method: <span class="string">&#x27;tls&#x27;</span></span><br><span class="line">  bind_dn: <span class="string">&#x27;uid=gitlab,cn=users,cn=accounts,dc=sonnyhcl,dc=top&#x27;</span></span><br><span class="line">  password: <span class="string">&#x27;gitlab&#x27;</span></span><br><span class="line">  encryption: <span class="string">&#x27;plain&#x27;</span></span><br><span class="line">  base: <span class="string">&#x27;cn=accounts,dc=sonnyhcl,dc=top&#x27;</span></span><br><span class="line">  verify_certificates: false</span><br><span class="line">  attributes:</span><br><span class="line">    username: [<span class="string">&#x27;uid&#x27;</span>]</span><br><span class="line">    email: [<span class="string">&#x27;mail&#x27;</span>]</span><br><span class="line">    name: <span class="string">&#x27;displayName&#x27;</span></span><br><span class="line">    first_name: <span class="string">&#x27;givenName&#x27;</span></span><br><span class="line">    last_name: <span class="string">&#x27;sn&#x27;</span></span><br><span class="line">    sync_ssh_keys: true</span><br><span class="line"><span class="symbol">EOS</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;backup_archive_permissions&#x27;</span>] = <span class="number">0644</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;backup_keep_time&#x27;</span>] = <span class="number">604800</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;backup_upload_connection&#x27;</span>] = &#123;</span><br><span class="line">  <span class="string">&#x27;provider&#x27;</span> =&gt; <span class="string">&#x27;AWS&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;region&#x27;</span> =&gt; <span class="string">&#x27;cn-north-1&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;aws_access_key_id&#x27;</span> =&gt; <span class="string">&#x27;xxxxxxxx&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;aws_secret_access_key&#x27;</span> =&gt; <span class="string">&#x27;xxxxxxxx&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">gitlab_rails[<span class="string">&#x27;backup_upload_remote_directory&#x27;</span>] = <span class="string">&#x27;gitlab-sonnyhcl-top&#x27;</span></span><br><span class="line">postgresql[<span class="string">&#x27;shared_buffers&#x27;</span>] = <span class="string">&quot;2048MB&quot;</span></span><br><span class="line">nginx[<span class="string">&#x27;real_ip_header&#x27;</span>] = <span class="string">&#x27;X-Forwarded-For&#x27;</span></span><br><span class="line">nginx[<span class="string">&#x27;custom_error_pages&#x27;</span>] = &#123;</span><br><span class="line">  <span class="string">&#x27;404&#x27;</span> =&gt; &#123;</span><br><span class="line">    <span class="string">&#x27;title&#x27;</span> =&gt; <span class="string">&#x27;404 Page&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;header&#x27;</span> =&gt; <span class="string">&#x27;GitLab&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;https://gitlab.sonnyhcl.top&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="配置docker-compose-yml"><a href="#配置docker-compose-yml" class="headerlink" title="配置docker-compose.yml"></a>配置docker-compose.yml</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">oem<span class="keyword">@gitlab</span>:~/compose$ cat docker-compose.yml </span><br><span class="line"><span class="attribute">version</span>: <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">services</span>:</span><br><span class="line">  <span class="attribute">gitlab</span>:</span><br><span class="line">   <span class="attribute">image</span>: <span class="string">&#x27;gitlab/gitlab-ce:latest&#x27;</span></span><br><span class="line">   <span class="attribute">restart</span>: unless-stopped</span><br><span class="line">   container_<span class="attribute">name</span>: gitlab</span><br><span class="line">   <span class="attribute">hostname</span>: <span class="string">&#x27;gitlab.sonnyhcl.top&#x27;</span></span><br><span class="line">   <span class="attribute">ports</span>:</span><br><span class="line">     - <span class="string">&#x27;80:80&#x27;</span></span><br><span class="line">     - <span class="string">&#x27;443:443&#x27;</span></span><br><span class="line">     - <span class="string">&#x27;22:22&#x27;</span></span><br><span class="line">   <span class="attribute">volumes</span>:</span><br><span class="line">     - <span class="string">&#x27;/srv/gitlab/config:/etc/gitlab&#x27;</span></span><br><span class="line">     - <span class="string">&#x27;/srv/gitlab/logs:/var/log/gitlab&#x27;</span></span><br><span class="line">     - <span class="string">&#x27;/srv/gitlab/data:/var/opt/gitlab&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="启动gitlab服务"><a href="#启动gitlab服务" class="headerlink" title="启动gitlab服务"></a>启动gitlab服务</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker-compose up -d</span></span><br></pre></td></tr></table></figure><h2 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h2><h3 id="备份到AWS"><a href="#备份到AWS" class="headerlink" title="备份到AWS"></a>备份到AWS</h3><pre><code>- 创建AWS S3存储桶 gitlab-sonnyhcl-top- 创建AWS IAM身份 gitlab.sonnyhcl.top- [x] 编程访问:为 AWS API、CLI、SDK 和其他开发工具启用 访问密钥 ID 和 私有访问密钥 。 - [x] 赋予AWS S3 Full Access</code></pre><h3 id="备份数据"><a href="#备份数据" class="headerlink" title="备份数据"></a>备份数据</h3><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -t gitlab gitlab-rake gitlab:backup:create &gt;&gt; <span class="regexp">/home/</span>clhu/gitlab-backup.log</span><br></pre></td></tr></table></figure><h3 id="备份配置"><a href="#备份配置" class="headerlink" title="备份配置"></a>备份配置</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -t gitlab <span class="regexp">/bin/</span>sh -c <span class="string">&quot;umask 0077; tar cfz /var/opt/gitlab/backups/config/$(date &quot;</span>+%s-etc-gitlab.tgz<span class="string">&quot;) -C / etc/gitlab&quot;</span></span><br></pre></td></tr></table></figure><h3 id="定时备份"><a href="#定时备份" class="headerlink" title="定时备份"></a>定时备份</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">clhu@gitlab:<span class="regexp">/srv/gi</span>tlab$ crontab -l</span><br><span class="line"><span class="comment"># m h  dom mon dow   command</span></span><br><span class="line"><span class="number">10</span> <span class="number">5</span> * * * docker exec -t gitlab gitlab-rake gitlab:backup:create &gt;&gt; <span class="regexp">/home/</span>clhu/gitlab-backup.log</span><br><span class="line"><span class="number">0</span> <span class="number">5</span> * * * docker exec -t gitlab <span class="regexp">/bin/</span>sh -c <span class="string">&quot;umask 0077; tar cfz /var/opt/gitlab/backups/config/$(date &quot;</span>+%s-etc-gitlab.tgz<span class="string">&quot;) -C / etc/gitlab&quot;</span></span><br></pre></td></tr></table></figure><h3 id="重启gitlab"><a href="#重启gitlab" class="headerlink" title="重启gitlab"></a>重启gitlab</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改gitlab.rb之后必须重配置一下</span></span><br><span class="line">docker <span class="built_in">exec</span> -t gitlab gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://docs.gitlab.com/omnibus/docker/#install-gitlab-using-docker-compose">https://docs.gitlab.com/omnibus/docker/#install-gitlab-using-docker-compose</a></li></ul><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;这个系列是笔者在为实验室搭建本地私有云的过程中所记载的笔记,看起来会比较杂乱 :)&lt;/p&gt;
&lt;p&gt;本文介绍在本地搭建自己的gitlab服务,并集成FreeIPA提供的LDAP认证&lt;/p&gt;</summary>
    
    
    
    <category term="Tech" scheme="https://sonnyhcl.com/categories/Tech/"/>
    
    
    <category term="on-premise-cloud" scheme="https://sonnyhcl.com/tags/on-premise-cloud/"/>
    
    <category term="FreeIPA" scheme="https://sonnyhcl.com/tags/FreeIPA/"/>
    
    <category term="GitLab" scheme="https://sonnyhcl.com/tags/GitLab/"/>
    
    <category term="LDAP" scheme="https://sonnyhcl.com/tags/LDAP/"/>
    
  </entry>
  
  <entry>
    <title>搭建本地私有云之FreeIPA主从备份</title>
    <link href="https://sonnyhcl.com/on-premise-freeipa-replica/"/>
    <id>https://sonnyhcl.com/on-premise-freeipa-replica/</id>
    <published>2019-10-17T05:04:09.000Z</published>
    <updated>2019-10-17T05:04:09.000Z</updated>
    
    <content type="html"><![CDATA[<p>这个系列是笔者在为实验室搭建本地私有云的过程中所记载的笔记,看起来会比较杂乱 :)</p><p>为了保证FreeIPA服务的稳定性,我们需要为它添加一个replica作为主从备份.</p><span id="more"></span><h1 id="Centos7-安装-FreeIPA-Replica"><a href="#Centos7-安装-FreeIPA-Replica" class="headerlink" title="Centos7 安装 FreeIPA Replica"></a>Centos7 安装 FreeIPA Replica</h1><blockquote><p>centos7 + 4vCPU + 4G</p></blockquote><h2 id="Profile"><a href="#Profile" class="headerlink" title="Profile"></a>Profile</h2><ul><li> ip: 192.168.128.122/22</li><li> hostname: ipa02.sonnyhcl.top</li><li> kerberos realm: SONNYHCL.TOP</li><li> dns domain: sonnyhcl.top</li><li> admin server: ipa.sonnyhcl.top</li><li> with DNS: yes</li><li> forwarder: 127.0.0.1, 202.120.224.6, 202.120.224.26</li></ul><h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h2><h3 id="设置-ipa02-的-DNS-记录"><a href="#设置-ipa02-的-DNS-记录" class="headerlink" title="设置 ipa02 的 DNS 记录"></a>设置 ipa02 的 DNS 记录</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">选择: 网络服务 -&gt; DNS 区域</span><br><span class="line">添加一个 <span class="number">192.168</span>.<span class="number">128.0</span>/<span class="number">22</span> 的反向区域 <span class="number">128.168</span>.<span class="number">192</span><span class="selector-class">.in-addr</span><span class="selector-class">.arpa</span>.</span><br><span class="line">点击 DNS 区域的 sonnyhcl<span class="selector-class">.top</span>. 进去这个子域内</span><br><span class="line">增加一条 ipa02<span class="selector-class">.sonnyhcl</span><span class="selector-class">.top</span> 的 A 记录，并且在 Create reverse 打勾，添加 IP 地址的反向记录</span><br></pre></td></tr></table></figure><h3 id="配置机器名-hostname"><a href="#配置机器名-hostname" class="headerlink" title="配置机器名 hostname"></a>配置机器名 hostname</h3><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">hostnamectl</span> <span class="built_in">set-hostname</span> <span class="string">ipa02</span>.<span class="string">sonnyhcl</span>.<span class="string">top</span></span><br><span class="line"><span class="string"></span><span class="comment"># hostname -f 查看</span></span><br></pre></td></tr></table></figure><h3 id="验证域名解析"><a href="#验证域名解析" class="headerlink" title="验证域名解析"></a>验证域名解析</h3><p>配置 ipa02 dns 为 192.168.128.121　然后验证正反解</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dig </span>+<span class="keyword">short </span>ipa02.sonnyhcl.top A</span><br><span class="line"><span class="keyword">dig </span>+<span class="keyword">short </span>-x <span class="number">192</span>.<span class="number">168</span>.<span class="number">128</span>.<span class="number">122</span></span><br></pre></td></tr></table></figure><h3 id="配置-etc-hosts"><a href="#配置-etc-hosts" class="headerlink" title="配置 /etc/hosts"></a>配置 /etc/hosts</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">&quot;192.168.128.121 ipa.sonnyhcl.top ipa&quot;</span> | sudo tee -a <span class="regexp">/etc/</span>hosts</span><br><span class="line">echo <span class="string">&quot;192.168.128.122 ipa02.sonnyhcl.top ipa02&quot;</span> | sudo tee -a <span class="regexp">/etc/</span>hosts</span><br></pre></td></tr></table></figure><h3 id="安装-FreeIPA-Client"><a href="#安装-FreeIPA-Client" class="headerlink" title="安装 FreeIPA Client"></a>安装 FreeIPA Client</h3><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">sudo</span> <span class="comment">yum</span> <span class="comment">install</span> <span class="comment">ipa</span><span class="literal">-</span><span class="comment">client</span></span><br><span class="line"><span class="comment">sudo</span> <span class="comment">ipa</span><span class="literal">-</span><span class="comment">client</span><span class="literal">-</span><span class="comment">install</span> --<span class="comment">mkhomedir</span> --<span class="comment">enable</span><span class="literal">-</span><span class="comment">dns</span><span class="literal">-</span><span class="comment">updates</span> --<span class="comment">server</span> <span class="comment">ipa</span><span class="string">.</span><span class="comment">sonnyhcl</span><span class="string">.</span><span class="comment">top</span> --<span class="comment">domain</span> <span class="comment">sonnyhcl</span><span class="string">.</span><span class="comment">top</span> --<span class="comment">realm</span> <span class="comment">SONNYHCL</span><span class="string">.</span><span class="comment">TOP</span> --<span class="comment">hostname</span> <span class="comment">ipa02</span><span class="string">.</span><span class="comment">sonnyhcl</span><span class="string">.</span><span class="comment">top</span></span><br></pre></td></tr></table></figure><h3 id="配置防火墙"><a href="#配置防火墙" class="headerlink" title="配置防火墙"></a>配置防火墙</h3><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">sudo</span> <span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> --<span class="comment">permanent</span> --<span class="comment">add</span><span class="literal">-</span><span class="comment">service=&#123;ntp</span><span class="string">,</span><span class="comment">http</span><span class="string">,</span><span class="comment">https</span><span class="string">,</span><span class="comment">ldap</span><span class="string">,</span><span class="comment">ldaps</span><span class="string">,</span><span class="comment">kerberos</span><span class="string">,</span><span class="comment">kpasswd</span><span class="string">,</span><span class="comment">dns&#125;</span></span><br><span class="line"><span class="comment">sudo</span> <span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> --<span class="comment">reload</span></span><br><span class="line"><span class="comment">sudo</span> <span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> --<span class="comment">list</span><span class="literal">-</span><span class="comment">all</span></span><br></pre></td></tr></table></figure><h3 id="安装-FreeIPA-Replica"><a href="#安装-FreeIPA-Replica" class="headerlink" title="安装 FreeIPA Replica"></a>安装 FreeIPA Replica</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install ipa-<span class="keyword">server</span> ipa-<span class="keyword">server</span>-dns</span><br><span class="line">sudo ipa-<span class="keyword">replica</span>-install</span><br></pre></td></tr></table></figure><h3 id="安装-FreeIPA-CA-Replica"><a href="#安装-FreeIPA-CA-Replica" class="headerlink" title="安装 FreeIPA CA Replica"></a>安装 FreeIPA CA Replica</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ipa-ca-<span class="keyword">install</span></span><br></pre></td></tr></table></figure><h3 id="安装-FreeIPA-DNS-Replica"><a href="#安装-FreeIPA-DNS-Replica" class="headerlink" title="安装 FreeIPA DNS Replica"></a>安装 FreeIPA DNS Replica</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ipa-dns-<span class="keyword">install</span></span><br></pre></td></tr></table></figure><h3 id="检查所有服务运行状态"><a href="#检查所有服务运行状态" class="headerlink" title="检查所有服务运行状态"></a>检查所有服务运行状态</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo ipactl status</span></span><br></pre></td></tr></table></figure><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Directory Service</span>: RUNNING</span><br><span class="line"><span class="attribute">krb5kdc Service</span>: RUNNING</span><br><span class="line"><span class="attribute">kadmin Service</span>: RUNNING</span><br><span class="line"><span class="attribute">named Service</span>: RUNNING</span><br><span class="line"><span class="attribute">httpd Service</span>: RUNNING</span><br><span class="line"><span class="attribute">ipa-custodia Service</span>: RUNNING</span><br><span class="line"><span class="attribute">ntpd Service</span>: RUNNING</span><br><span class="line"><span class="attribute">pki-tomcatd Service</span>: RUNNING</span><br><span class="line"><span class="attribute">ipa-otpd Service</span>: RUNNING</span><br><span class="line"><span class="attribute">ipa-dnskeysyncd Service</span>: RUNNING</span><br><span class="line"><span class="attribute">ipa</span>: INFO: The ipactl command was successful</span><br></pre></td></tr></table></figure><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://qizhanming.com/blog/2019/04/29/install-freeipa-server-and-replica-on-centos-7">CentOS 7 安装 FreeIPA 主从复制</a></li><li><a href="https://computingforgeeks.com/how-to-configure-freeipa-replication-on-ubuntu-centos/">How to Configure FreeIPA replication on Ubuntu / CentOS</a></li></ul><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;这个系列是笔者在为实验室搭建本地私有云的过程中所记载的笔记,看起来会比较杂乱 :)&lt;/p&gt;
&lt;p&gt;为了保证FreeIPA服务的稳定性,我们需要为它添加一个replica作为主从备份.&lt;/p&gt;</summary>
    
    
    
    <category term="Tech" scheme="https://sonnyhcl.com/categories/Tech/"/>
    
    
    <category term="on-premise-cloud" scheme="https://sonnyhcl.com/tags/on-premise-cloud/"/>
    
    <category term="FreeIPA" scheme="https://sonnyhcl.com/tags/FreeIPA/"/>
    
    <category term="FreeIPA replica" scheme="https://sonnyhcl.com/tags/FreeIPA-replica/"/>
    
  </entry>
  
  <entry>
    <title>搭建本地私有云之FreeIPA的https</title>
    <link href="https://sonnyhcl.com/on-premise-freeipa-webui-https/"/>
    <id>https://sonnyhcl.com/on-premise-freeipa-webui-https/</id>
    <published>2019-10-17T04:55:57.000Z</published>
    <updated>2019-10-17T04:55:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>这个系列是笔者在为实验室搭建本地私有云的过程中所记载的笔记,看起来会比较杂乱 :)</p><p>在<a href="on-premise-freeipa">安装完FreeIPA</a>之后,访问WebUI会遇到https证书的问题,因为到目前为止还是自签名的证书,本文中我们就来为FreeIPA加上认证过的阿里云域名证书</p><span id="more"></span><h2 id="阿里云SSL域名证书"><a href="#阿里云SSL域名证书" class="headerlink" title="阿里云SSL域名证书"></a>阿里云SSL域名证书</h2><p>从阿里云可以下载到<code>2259124_ipa.sonnyhcl.top_tomcat.zip</code>的域名证书</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ipa</span> <span class="number">2259124</span>_ipa.sonnyhcl.top_tomcat]<span class="meta"># tree -L 2</span></span><br><span class="line">.</span><br><span class="line">├── <span class="number">2259124</span>_ipa.sonnyhcl.top.pfx  <span class="meta"># 二进制文件</span></span><br><span class="line">└── pfx-password.txt                <span class="meta"># 证书密码</span></span><br></pre></td></tr></table></figure><h2 id="IPA引入CA证书"><a href="#IPA引入CA证书" class="headerlink" title="IPA引入CA证书"></a>IPA引入CA证书</h2><p>阿里云的认证链是 <code>DigiCert Global Root CA</code> -&gt; <code>Encryption Everywhere DV TLS CA - G1</code> -&gt; <code>ipa.sonnyhcl.top</code></p><ul><li><code>DigiCert.crt</code><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIDrzCCApegAwIBAgIQCDvgVpBCRrGhdWrJWZHHSjANBgkqhkiG9w0BAQUFADBh</span><br><span class="line">MQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMRkwFwYDVQQLExB3</span><br><span class="line">d3cuZGlnaWNlcnQuY29tMSAwHgYDVQQDExdEaWdpQ2VydCBHbG9iYWwgUm9vdCBD</span><br><span class="line">QTAeFw0wNjExMTAwMDAwMDBaFw0zMTExMTAwMDAwMDBaMGExCzAJBgNVBAYTAlVT</span><br><span class="line">MRUwEwYDVQQKEwxEaWdpQ2VydCBJbmMxGTAXBgNVBAsTEHd3dy5kaWdpY2VydC5j</span><br><span class="line">b20xIDAeBgNVBAMTF0RpZ2lDZXJ0IEdsb2JhbCBSb290IENBMIIBIjANBgkqhkiG</span><br><span class="line">9w0BAQEFAAOCAQ8AMIIBCgKCAQEA4jvhEXLeqKTTo1eqUKKPC3eQyaKl7hLOllsB</span><br><span class="line">CSDMAZOnTjC3U/dDxGkAV53ijSLdhwZAAIEJzs4bg7/fzTtxRuLWZscFs3YnFo97</span><br><span class="line">nh6Vfe63SKMI2tavegw5BmV/Sl0fvBf4q77uKNd0f3p4mVmFaG5cIzJLv07A6Fpt</span><br><span class="line">43C/dxC//AH2hdmoRBBYMql1GNXRor5H4idq9Joz+EkIYIvUX7Q6hL+hqkpMfT7P</span><br><span class="line">T19sdl6gSzeRntwi5m3OFBqOasv+zbMUZBfHWymeMr/y7vrTC0LUq7dBMtoM1O/4</span><br><span class="line">gdW7jVg/tRvoSSiicNoxBN33shbyTApOB6jtSj1etX+jkMOvJwIDAQABo2MwYTAO</span><br><span class="line">BgNVHQ8BAf8EBAMCAYYwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQUA95QNVbR</span><br><span class="line">TLtm8KPiGxvDl7I90VUwHwYDVR0jBBgwFoAUA95QNVbRTLtm8KPiGxvDl7I90VUw</span><br><span class="line">DQYJKoZIhvcNAQEFBQADggEBAMucN6pIExIK+t1EnE9SsPTfrgT1eXkIoyQY/Esr</span><br><span class="line">hMAtudXH/vTBH1jLuG2cenTnmCmrEbXjcKChzUyImZOMkXDiqw8cvpOp/2PV5Adg</span><br><span class="line">06O/nVsJ8dWO41P0jmP6P6fbtGbfYmbW0W5BjfIttep3Sp+dWOIrWcBAI+0tKIJF</span><br><span class="line">PnlUkiaY4IBIqDfv8NZ5YBberOgOzW6sRBc4L0na4UU+Krk2U886UAb3LujEV0ls</span><br><span class="line">YSEY1QSteDwsOoBrp+uvFRTp2InBuThs4pFsiv9kuXclVzDAGySj4dzp30d8tbQk</span><br><span class="line">CAUw7C29C79Fv1C5qfPrmAESrciIxpg0X40KPMbp1ZWVbd4=</span><br><span class="line">-----END CERTIFICATE-----</span><br></pre></td></tr></table></figure></li><li><code>Encryption.crt</code><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIEqjCCA5KgAwIBAgIQAnmsRYvBskWr+YBTzSybsTANBgkqhkiG9w0BAQsFADBh</span><br><span class="line">MQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMRkwFwYDVQQLExB3</span><br><span class="line">d3cuZGlnaWNlcnQuY29tMSAwHgYDVQQDExdEaWdpQ2VydCBHbG9iYWwgUm9vdCBD</span><br><span class="line">QTAeFw0xNzExMjcxMjQ2MTBaFw0yNzExMjcxMjQ2MTBaMG4xCzAJBgNVBAYTAlVT</span><br><span class="line">MRUwEwYDVQQKEwxEaWdpQ2VydCBJbmMxGTAXBgNVBAsTEHd3dy5kaWdpY2VydC5j</span><br><span class="line">b20xLTArBgNVBAMTJEVuY3J5cHRpb24gRXZlcnl3aGVyZSBEViBUTFMgQ0EgLSBH</span><br><span class="line">MTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALPeP6wkab41dyQh6mKc</span><br><span class="line">oHqt3jRIxW5MDvf9QyiOR7VfFwK656es0UFiIb74N9pRntzF1UgYzDGu3ppZVMdo</span><br><span class="line">lbxhm6dWS9OK/lFehKNT0OYI9aqk6F+U7cA6jxSC+iDBPXwdF4rs3KRyp3aQn6pj</span><br><span class="line">pp1yr7IB6Y4zv72Ee/PlZ/6rK6InC6WpK0nPVOYR7n9iDuPe1E4IxUMBH/T33+3h</span><br><span class="line">yuH3dvfgiWUOUkjdpMbyxX+XNle5uEIiyBsi4IvbcTCh8ruifCIi5mDXkZrnMT8n</span><br><span class="line">wfYCV6v6kDdXkbgGRLKsR4pucbJtbKqIkUGxuZI2t7pfewKRc5nWecvDBZf3+p1M</span><br><span class="line">pA8CAwEAAaOCAU8wggFLMB0GA1UdDgQWBBRVdE+yck/1YLpQ0dfmUVyaAYca1zAf</span><br><span class="line">BgNVHSMEGDAWgBQD3lA1VtFMu2bwo+IbG8OXsj3RVTAOBgNVHQ8BAf8EBAMCAYYw</span><br><span class="line">HQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUFBwMCMBIGA1UdEwEB/wQIMAYBAf8C</span><br><span class="line">AQAwNAYIKwYBBQUHAQEEKDAmMCQGCCsGAQUFBzABhhhodHRwOi8vb2NzcC5kaWdp</span><br><span class="line">Y2VydC5jb20wQgYDVR0fBDswOTA3oDWgM4YxaHR0cDovL2NybDMuZGlnaWNlcnQu</span><br><span class="line">Y29tL0RpZ2lDZXJ0R2xvYmFsUm9vdENBLmNybDBMBgNVHSAERTBDMDcGCWCGSAGG</span><br><span class="line">/WwBAjAqMCgGCCsGAQUFBwIBFhxodHRwczovL3d3dy5kaWdpY2VydC5jb20vQ1BT</span><br><span class="line">MAgGBmeBDAECATANBgkqhkiG9w0BAQsFAAOCAQEAK3Gp6/aGq7aBZsxf/oQ+TD/B</span><br><span class="line">SwW3AU4ETK+GQf2kFzYZkby5SFrHdPomunx2HBzViUchGoofGgg7gHW0W3MlQAXW</span><br><span class="line">M0r5LUvStcr82QDWYNPaUy4taCQmyaJ+VB+6wxHstSigOlSNF2a6vg4rgexixeiV</span><br><span class="line">4YSB03Yqp2t3TeZHM9ESfkus74nQyW7pRGezj+TC44xCagCQQOzzNmzEAP2SnCrJ</span><br><span class="line">sNE2DpRVMnL8J6xBRdjmOsC3N6cQuKuRXbzByVBjCqAA8t1L0I+9wXJerLPyErjy</span><br><span class="line">rMKWaBFLmfK/AHNF4ZihwPGOc7w6UHczBZXH5RFzJNnww+WnKuTPI0HfnVH8lg==</span><br><span class="line">-----END CERTIFICATE-----</span><br></pre></td></tr></table></figure></li><li>import CA<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ipa-cacert-manage -<span class="built_in">n</span> DigiCert -<span class="built_in">t</span> C,, install DigiCert.crt</span><br><span class="line">ipa-cacert-manage -<span class="built_in">n</span> Encryption -<span class="built_in">t</span> C,, install Encryption.crt</span><br><span class="line">ipa-certupdate -v</span><br></pre></td></tr></table></figure></li></ul><h2 id="IPA-WebUI-引入域名证书"><a href="#IPA-WebUI-引入域名证书" class="headerlink" title="IPA WebUI 引入域名证书"></a>IPA WebUI 引入域名证书</h2><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat pfx-<span class="keyword">password</span>.txt | ipa-<span class="keyword">server</span>-certinstall -w ipa.sonnyhcl.top.pfx</span><br><span class="line">sudo ipactl <span class="keyword">restart</span></span><br></pre></td></tr></table></figure><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://blog.soholabs.org/lets-encrypt-and-the-freeipa-web-gui/">https://blog.soholabs.org/lets-encrypt-and-the-freeipa-web-gui/</a></li></ul><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;这个系列是笔者在为实验室搭建本地私有云的过程中所记载的笔记,看起来会比较杂乱 :)&lt;/p&gt;
&lt;p&gt;在&lt;a href=&quot;on-premise-freeipa&quot;&gt;安装完FreeIPA&lt;/a&gt;之后,访问WebUI会遇到https证书的问题,因为到目前为止还是自签名的证书,本文中我们就来为FreeIPA加上认证过的阿里云域名证书&lt;/p&gt;</summary>
    
    
    
    <category term="Tech" scheme="https://sonnyhcl.com/categories/Tech/"/>
    
    
    <category term="on-premise-cloud" scheme="https://sonnyhcl.com/tags/on-premise-cloud/"/>
    
    <category term="FreeIPA" scheme="https://sonnyhcl.com/tags/FreeIPA/"/>
    
    <category term="FreeIPA WebUI" scheme="https://sonnyhcl.com/tags/FreeIPA-WebUI/"/>
    
    <category term="SSL" scheme="https://sonnyhcl.com/tags/SSL/"/>
    
    <category term="https" scheme="https://sonnyhcl.com/tags/https/"/>
    
  </entry>
  
  <entry>
    <title>搭建本地私有云之DHCP</title>
    <link href="https://sonnyhcl.com/on-premise-dhcp/"/>
    <id>https://sonnyhcl.com/on-premise-dhcp/</id>
    <published>2019-10-17T04:35:11.000Z</published>
    <updated>2019-10-17T04:35:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>这个系列是笔者在为实验室搭建本地私有云的过程中所记载的笔记,看起来会比较杂乱 :)</p><p>在搭建本地私有云时,双网口的配置意味着我们需要为两个网段分别配置IP规则,有必要为内网部署一个自动分配IP的dhcp服务.</p><span id="more"></span><p>当然,这一需求也可以由高级一点的交换机/路由器来完成,介于我们并没有交换机的预算,采用手动搭建dhcp服务器来解决</p><h2 id="Profile"><a href="#Profile" class="headerlink" title="Profile"></a>Profile</h2><p>我们的每台服务器上都有两个千兆网口,可以分别用来传输内部数据以及访问校园网</p><ul><li><p>内网：静态地址 192.168.128.123/22</p></li><li><p>校园网：v4静态地址,由校园网分配. v6自动，可以连到ustc</p></li><li><p>本文的dhcpd 只为内网配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">/etc/netplan/01-netcfg.yaml</span> </span><br><span class="line"><span class="comment"># This file describes the network interfaces available on your system</span></span><br><span class="line"><span class="comment"># For more information, see netplan(5).</span></span><br><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">renderer:</span> <span class="string">NetworkManager</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">    <span class="attr">ens3:</span></span><br><span class="line">      <span class="attr">dhcp4:</span> <span class="literal">no</span></span><br><span class="line">      <span class="attr">dhcp6:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">mtu:</span> <span class="number">8046</span></span><br><span class="line">      <span class="attr">addresses:</span> [<span class="number">192.168</span><span class="number">.128</span><span class="number">.123</span><span class="string">/22</span>]</span><br><span class="line">      <span class="attr">nameservers:</span></span><br><span class="line">        <span class="attr">search:</span> [<span class="string">sonnyhcl.top</span>]</span><br><span class="line">        <span class="attr">addresses:</span> [<span class="number">192.168</span><span class="number">.128</span><span class="number">.121</span>, <span class="number">192.168</span><span class="number">.128</span><span class="number">.122</span>]</span><br><span class="line"><span class="comment">#    ens5:</span></span><br><span class="line"><span class="comment">#      dhcp4: no</span></span><br><span class="line"><span class="comment">#      dhcp6: yes</span></span><br><span class="line"><span class="comment">#      addresses: [10.141.209.177/20]</span></span><br><span class="line"><span class="comment">#      gateway4: 10.141.208.1</span></span><br></pre></td></tr></table></figure></li><li><p>网络配置常用命令</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo</span> netplan --<span class="literal">debug</span> apply</span><br></pre></td></tr></table></figure></li></ul><h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h2><h3 id="下载-dhcp-包"><a href="#下载-dhcp-包" class="headerlink" title="下载 dhcp 包"></a>下载 dhcp 包</h3><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y isc-dhcp-<span class="keyword">server</span></span><br></pre></td></tr></table></figure><h3 id="配置-etc-default-isc-dhcp-server"><a href="#配置-etc-default-isc-dhcp-server" class="headerlink" title="配置 /etc/default/isc-dhcp-server"></a>配置 /etc/default/isc-dhcp-server</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Defaults for isc-dhcp-server (sourced by /etc/init.d/isc-dhcp-server)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Path to dhcpd&#x27;s config file (default: /etc/dhcp/dhcpd.conf).</span></span><br><span class="line"><span class="attr">DHCPDv4_CONF</span>=/etc/dhcp/dhcpd.conf</span><br><span class="line"><span class="comment">#DHCPDv6_CONF=/etc/dhcp/dhcpd6.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Path to dhcpd&#x27;s PID file (default: /var/run/dhcpd.pid).</span></span><br><span class="line"><span class="attr">DHCPDv4_PID</span>=/var/run/dhcpd.pid</span><br><span class="line"><span class="comment">#DHCPDv6_PID=/var/run/dhcpd6.pid</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Additional options to start dhcpd with.</span></span><br><span class="line"><span class="comment">#Don&#x27;t use options -cf or -pf here; use DHCPD_CONF/ DHCPD_PID instead</span></span><br><span class="line"><span class="comment">#OPTIONS=&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># On what interfaces should the DHCP server (dhcpd) serve DHCP requests?</span></span><br><span class="line"><span class="comment">#Separate multiple interfaces with spaces, e.g. &quot;eth0 eth1&quot;.</span></span><br><span class="line"><span class="attr">INTERFACESv4</span>=<span class="string">&quot;ens3&quot;</span></span><br><span class="line"><span class="attr">INTERFACESv6</span>=<span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><h3 id="配置-etc-dhcp-dhcpd-conf"><a href="#配置-etc-dhcp-dhcpd-conf" class="headerlink" title="配置 /etc/dhcp/dhcpd.conf"></a>配置 /etc/dhcp/dhcpd.conf</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dhcpd.conf</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Sample configuration file for ISC dhcpd</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Attention: If /etc/ltsp/dhcpd.conf exists, that will be used as</span></span><br><span class="line"><span class="comment"># configuration file instead of this file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># option definitions common to all supported networks...</span></span><br><span class="line">option domain-<span class="built_in">name</span> <span class="string">&quot;sonnyhcl.top&quot;</span>;</span><br><span class="line">option domain-<span class="built_in">name</span>-servers ipa.sonnyhcl.top, ipa02.sonnyhcl.top;</span><br><span class="line"></span><br><span class="line">default-lease-<span class="built_in">time</span> <span class="number">14400</span>;</span><br><span class="line">max-lease-<span class="built_in">time</span> <span class="number">172800</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># The ddns-updates-style parameter controls whether or not the server will</span></span><br><span class="line"><span class="comment"># attempt to do a DNS update when a lease is confirmed. We default to the</span></span><br><span class="line"><span class="comment"># behavior of the version 2 packages (&#x27;none&#x27;, since DHCP v2 didn&#x27;t</span></span><br><span class="line"><span class="comment"># have support for DDNS.)</span></span><br><span class="line">ddns-update-style interim;</span><br><span class="line">ddns-updates <span class="keyword">on</span>;</span><br><span class="line">ddns-domainname <span class="string">&quot;sonnyhcl.top&quot;</span>;</span><br><span class="line">ddns-rev-domainname <span class="string">&quot;in-addr.arpa&quot;</span>;</span><br><span class="line"></span><br><span class="line">zone <span class="number">168.192</span>.<span class="keyword">in</span>-addr.arpa. &#123; primary ipa.sonnyhcl.top;  &#125;</span><br><span class="line"></span><br><span class="line">zone sonnyhcl.top. &#123; primary ipa;&#125;</span><br><span class="line"></span><br><span class="line">subnet <span class="number">192.168</span><span class="number">.128</span><span class="number">.0</span> netmask <span class="number">255.255</span><span class="number">.252</span><span class="number">.0</span> &#123;</span><br><span class="line">  range <span class="number">192.168</span><span class="number">.130</span><span class="number">.1</span> <span class="number">192.168</span><span class="number">.131</span><span class="number">.254</span>;</span><br><span class="line">  default-lease-<span class="built_in">time</span> <span class="number">14400</span>;</span><br><span class="line">  max-lease-<span class="built_in">time</span> <span class="number">172800</span>;</span><br><span class="line">  zone sonnyhcl.top. &#123; primary <span class="number">192.168</span><span class="number">.128</span><span class="number">.2</span>; &#125;</span><br><span class="line">  zone <span class="keyword">in</span>-addr.arpa. &#123; primary <span class="number">192.168</span><span class="number">.128</span><span class="number">.2</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># If this DHCP server is the official DHCP server for the local</span></span><br><span class="line"><span class="comment"># network, the authoritative directive should be uncommented.</span></span><br><span class="line">authoritative;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this to send dhcp log messages to a different log file (you also</span></span><br><span class="line"><span class="comment"># have to hack syslog.conf to complete the redirection).</span></span><br><span class="line"><span class="built_in">log</span>-facility local7;</span><br></pre></td></tr></table></figure><h3 id="启动-dhcp"><a href="#启动-dhcp" class="headerlink" title="启动 dhcp"></a>启动 dhcp</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="keyword">enable</span> isc-dhcp-<span class="keyword">server</span></span><br><span class="line">sudo systemctl <span class="keyword">restart</span> isc-dhcp-<span class="keyword">server</span></span><br></pre></td></tr></table></figure><h3 id="检查-dhcp-运行状况"><a href="#检查-dhcp-运行状况" class="headerlink" title="检查 dhcp 运行状况"></a>检查 dhcp 运行状况</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ ip a s</span><br><span class="line"><span class="number">1</span>: lo: <span class="variable">&lt;LOOPBACK,UP,LOWER_UP&gt;</span> mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    <span class="keyword">inet</span> <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> ::<span class="number">1</span>/<span class="number">128</span> scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">2</span>: ens3: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">8046</span> qdisc fq_codel <span class="keyword">state</span> UP <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">00</span>:be:e4:<span class="number">86</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">128.123</span>/<span class="number">22</span> brd <span class="number">192.168</span>.<span class="number">131.255</span> scope <span class="keyword">global</span> noprefixroute ens3</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">5054</span>:ff:febe:e486/<span class="number">64</span> scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">3</span>: ens5: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc fq_codel <span class="keyword">state</span> UP <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">00</span>:<span class="number">7</span>a:<span class="number">30</span>:<span class="number">9</span>f brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet6</span> <span class="number">2001</span>:da8:<span class="number">8001</span>:<span class="number">2303</span>:<span class="number">79</span>db:<span class="number">51</span>e5:be9b:<span class="number">8</span>f7a/<span class="number">64</span> scope <span class="keyword">global</span> temporary dynamic </span><br><span class="line">       valid_lft <span class="number">565778</span>sec preferred_lft <span class="number">47281</span>sec</span><br><span class="line">    <span class="keyword">inet6</span> <span class="number">2001</span>:da8:<span class="number">8001</span>:<span class="number">2303</span>:e0cf:f5bd:b6b1:b7f1/<span class="number">64</span> scope <span class="keyword">global</span> dynamic mngtmpaddr noprefixroute </span><br><span class="line">       valid_lft <span class="number">2592000</span>sec preferred_lft <span class="number">604800</span>sec</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">4</span>c49:<span class="number">2102</span>:<span class="number">7423</span>:e6ff/<span class="number">64</span> scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line">$ hostnamectl</span><br><span class="line">   Static hostname: dhcp.sonnyhcl.top</span><br><span class="line">         Icon name: computer-vm</span><br><span class="line">           Chassis: vm</span><br><span class="line">        Machine ID: e6811e2f509944c4adefc8176aaa406e</span><br><span class="line">           Boot ID: <span class="number">144</span>f1851104644cfbd4275ae3450cdb4</span><br><span class="line">    Virtualization: kvm</span><br><span class="line">  Operating System: Ubuntu <span class="number">18.04</span>.<span class="number">2</span> LTS</span><br><span class="line">            Kernel: Linux <span class="number">4.15</span>.<span class="number">0</span>-<span class="number">50</span>-generic</span><br><span class="line">      Architecture: x86-<span class="number">64</span></span><br><span class="line">      </span><br><span class="line">$ systemd-resolve --status ens3</span><br><span class="line">Link <span class="number">2</span> (ens3)</span><br><span class="line">      Current Scopes: DNS</span><br><span class="line">       LLMNR setting: yes</span><br><span class="line">MulticastDNS setting: <span class="keyword">no</span></span><br><span class="line">      DNSSEC setting: <span class="keyword">no</span></span><br><span class="line">    DNSSEC supported: <span class="keyword">no</span></span><br><span class="line">         DNS Servers: <span class="number">192.168</span>.<span class="number">128.121</span></span><br><span class="line">                      <span class="number">192.168</span>.<span class="number">128.122</span></span><br><span class="line">                      <span class="number">202.120</span>.<span class="number">224.6</span></span><br><span class="line">                      <span class="number">202.120</span>.<span class="number">224.26</span></span><br><span class="line">          DNS Domain: ~.</span><br><span class="line">                      sonnyhcl.top</span><br><span class="line"></span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;这个系列是笔者在为实验室搭建本地私有云的过程中所记载的笔记,看起来会比较杂乱 :)&lt;/p&gt;
&lt;p&gt;在搭建本地私有云时,双网口的配置意味着我们需要为两个网段分别配置IP规则,有必要为内网部署一个自动分配IP的dhcp服务.&lt;/p&gt;</summary>
    
    
    
    <category term="Tech" scheme="https://sonnyhcl.com/categories/Tech/"/>
    
    
    <category term="on-premise-cloud" scheme="https://sonnyhcl.com/tags/on-premise-cloud/"/>
    
    <category term="dhcp" scheme="https://sonnyhcl.com/tags/dhcp/"/>
    
  </entry>
  
  <entry>
    <title>搭建本地私有云之域控认证FreeIPA</title>
    <link href="https://sonnyhcl.com/on-premise-freeipa/"/>
    <id>https://sonnyhcl.com/on-premise-freeipa/</id>
    <published>2019-10-17T03:29:04.000Z</published>
    <updated>2019-10-17T03:29:04.000Z</updated>
    
    <content type="html"><![CDATA[<p>这个系列是笔者在为实验室搭建本地私有云的过程中所记载的笔记,看起来会比较杂乱 :)</p><p>当我们搭建本地私有云的时候,首先要考虑的就是一套统一的用户认证管理系统.</p><span id="more"></span><p>市场上常用的用户管理有这么几种</p><ol><li>可以选择手动搭建LDAP服务并自己进行管理,这是最为复杂的操作</li><li>选择一套较完善的开源方案,例如我们这里选用的FreeIPA,集成了认证/域控/用户管理等多种功能</li><li>选择使用Active Directory,除了收费之外一切都是顶配,不折腾省心</li></ol><p>FreeIPA官方目前对<code>RedHat~Centos~Fedora&gt;Ubuntu~Debian</code>几家做的兼容性比较多,这里记录了Centos和Ubuntu上安装ipa server的过程。</p><h1 id="Centos7-安装-FreeIPA-Server"><a href="#Centos7-安装-FreeIPA-Server" class="headerlink" title="Centos7 安装 FreeIPA Server"></a>Centos7 安装 FreeIPA Server</h1><blockquote><p>Centos + 4vCPU + 4G</p></blockquote><h2 id="Profile"><a href="#Profile" class="headerlink" title="Profile"></a>Profile</h2><ul><li> ip: 192.168.128.121</li><li> kerberos realm: SONNYHCL.TOP</li><li> dns domain: sonnyhcl.top</li><li> admin server: ipa.sonnyhcl.top</li><li> with DNS: yes</li><li> forwarder: 127.0.0.1, 202.120.224.6, 202.120.224.26</li></ul><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="配置机器名-hostname"><a href="#配置机器名-hostname" class="headerlink" title="配置机器名 hostname"></a>配置机器名 hostname</h3><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="string">sudo</span> <span class="string">hostnamectl</span> <span class="built_in">set-hostname</span> <span class="string">ipa</span>.<span class="string">sonnyhcl</span>.<span class="string">top</span></span><br><span class="line"><span class="string"></span>$ <span class="string">hostname</span> -<span class="string">f</span></span><br><span class="line"><span class="string">ipa</span>.<span class="string">sonnyhcl</span>.<span class="string">top</span></span><br></pre></td></tr></table></figure><h3 id="配置-etc-hosts"><a href="#配置-etc-hosts" class="headerlink" title="配置 /etc/hosts"></a>配置 /etc/hosts</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &lt;ip fqdn shortname&gt;</span></span><br><span class="line">$ echo <span class="string">&quot;192.168.128.121 ipa.sonnyhcl.top ipa&quot;</span> |  sudo tee -a <span class="regexp">/etc/</span>hosts</span><br></pre></td></tr></table></figure><h3 id="配置随机数硬件加速"><a href="#配置随机数硬件加速" class="headerlink" title="配置随机数硬件加速"></a>配置随机数硬件加速</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum update -y</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install rng-tools</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl <span class="built_in">enable</span> rngd</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl status rngd</span></span><br></pre></td></tr></table></figure><h3 id="下载-FreeIPA-Server"><a href="#下载-FreeIPA-Server" class="headerlink" title="下载 FreeIPA-Server"></a>下载 FreeIPA-Server</h3><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum install -y ipa-<span class="keyword">server</span> ipa-<span class="keyword">server</span>-dns</span><br></pre></td></tr></table></figure><h3 id="配置-FreeIPA-Server"><a href="#配置-FreeIPA-Server" class="headerlink" title="配置 FreeIPA-Server"></a>配置 FreeIPA-Server</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ipa-<span class="keyword">server</span>-install <span class="comment">--allow-zone-overlap</span></span><br></pre></td></tr></table></figure><p>  接下来要输入参数如下<br>  <figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- <span class="keyword">Do</span> you want <span class="keyword">to</span> configure integrated DNS (BIND)? [<span class="keyword">no</span>]: yes</span><br><span class="line">- <span class="keyword">Server</span> host <span class="type">name</span> [ipa.sonnyhcl.top]: &lt;Enter&gt;</span><br><span class="line">- Please confirm the <span class="keyword">domain</span> <span class="type">name</span> [sonnyhcl.top]: &lt;Enter&gt;</span><br><span class="line">- Please provide a realm <span class="type">name</span> [SONNYHCL.TOP]: &lt;Enter&gt;</span><br><span class="line">- Directory Manager <span class="keyword">password</span>: &lt;secure <span class="keyword">password</span>&gt;</span><br><span class="line">- <span class="keyword">Password</span> (confirm): &lt;secure <span class="keyword">password</span>&gt;</span><br><span class="line">- IPA <span class="keyword">admin</span> <span class="keyword">password</span>: &lt;secure <span class="keyword">password</span>&gt;</span><br><span class="line">- <span class="keyword">Password</span> (confirm): &lt;secure <span class="keyword">password</span>&gt;</span><br></pre></td></tr></table></figure></p><h3 id="配置-authconfig"><a href="#配置-authconfig" class="headerlink" title="配置 authconfig"></a>配置 authconfig</h3><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">$</span> <span class="comment">sudo</span> <span class="comment">authconfig</span> --<span class="comment">enablemkhomedir</span> --<span class="comment">update</span></span><br></pre></td></tr></table></figure><h3 id="开启防火墙"><a href="#开启防火墙" class="headerlink" title="开启防火墙"></a>开启防火墙</h3><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">$</span> <span class="comment">sudo</span> <span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> --<span class="comment">permanent</span> --<span class="comment">add</span><span class="literal">-</span><span class="comment">service=&#123;ntp</span><span class="string">,</span><span class="comment">http</span><span class="string">,</span><span class="comment">https</span><span class="string">,</span><span class="comment">ldap</span><span class="string">,</span><span class="comment">ldaps</span><span class="string">,</span><span class="comment">kerberos</span><span class="string">,</span><span class="comment">kpasswd</span><span class="string">,</span><span class="comment">dns&#125;</span></span><br><span class="line"><span class="comment">$</span> <span class="comment">sudo</span> <span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> --<span class="comment">reload</span></span><br><span class="line"><span class="comment">$</span> <span class="comment">sudo</span> <span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> --<span class="comment">list</span><span class="literal">-</span><span class="comment">all</span></span><br></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="测试-kerberos"><a href="#测试-kerberos" class="headerlink" title="测试 kerberos"></a>测试 kerberos</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kinit admin</span><br><span class="line">Password for admin<span class="keyword">@SONNYHCL</span>.<span class="attribute">TOP</span>:</span><br><span class="line">$ klist</span><br><span class="line">Ticket <span class="attribute">cache</span>: <span class="attribute">KEYRING</span>:<span class="attribute">persistent</span>:<span class="number">0</span>:<span class="number">0</span></span><br><span class="line">Default <span class="attribute">principal</span>: admin<span class="keyword">@SONNYHCL</span>.TOP</span><br><span class="line"></span><br><span class="line">Valid starting     Expires            Service principal</span><br><span class="line"><span class="number">06</span>/<span class="number">29</span>/<span class="number">18</span> <span class="number">22</span>:<span class="number">52</span>:<span class="number">40</span>  <span class="number">06</span>/<span class="number">30</span>/<span class="number">18</span> <span class="number">22</span>:<span class="number">52</span>:<span class="number">36</span>  krbtgt/SONNYHCL.TOP<span class="keyword">@SONNYHCL</span>.TOP</span><br></pre></td></tr></table></figure><h3 id="测试-ipa"><a href="#测试-ipa" class="headerlink" title="测试 ipa"></a>测试 ipa</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ ipa user-find admin</span><br><span class="line">--------------</span><br><span class="line">1 user matched</span><br><span class="line">--------------</span><br><span class="line"></span><br><span class="line"><span class="code">  User login: admin</span></span><br><span class="line"><span class="code">  Last name: Administrator</span></span><br><span class="line"><span class="code">  Home directory: /home/admin</span></span><br><span class="line"><span class="code">  Login shell: /bin/bash</span></span><br><span class="line"><span class="code">  Principal alias: admin@COMPUTINGFORGEEKS.COM</span></span><br><span class="line"><span class="code">  UID: 1506000000</span></span><br><span class="line"><span class="code">  GID: 1506000000</span></span><br><span class="line"><span class="code">  Account disabled: False</span></span><br><span class="line"><span class="code">  ----------------------------</span></span><br><span class="line"><span class="code">  Number of entries returned 1</span></span><br><span class="line"><span class="code">  ----------------------------</span></span><br><span class="line">$ sudo ipactl status</span><br><span class="line">Directory Service: RUNNING</span><br><span class="line">krb5kdc Service: RUNNING</span><br><span class="line">kadmin Service: RUNNING</span><br><span class="line">named Service: RUNNING</span><br><span class="line">httpd Service: RUNNING</span><br><span class="line">ipa-custodia Service: RUNNING</span><br><span class="line">ntpd Service: RUNNING</span><br><span class="line">pki-tomcatd Service: RUNNING</span><br><span class="line">ipa-otpd Service: RUNNING</span><br><span class="line">ipa-dnskeysyncd Service: RUNNING</span><br><span class="line">ipa: INFO: The ipactl command was successful</span><br></pre></td></tr></table></figure><h3 id="测试-Web-UI"><a href="#测试-Web-UI" class="headerlink" title="测试 Web UI"></a>测试 Web UI</h3><p>如果在虚拟机中部署，在宿主机访问，请确保你的宿主机　hosts　里面也写入了第2步中的域名解析</p><p>访问<code>https://ipa.sonnyhcl.top/ipa/ui</code>，选择　高级　-&gt;　继续访问　即可跳过浏览器对 https 证书的质疑。输入刚刚创建的<code>admin</code>账户密码即可进入 Web 管理界面。</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://qizhanming.com/blog/2019/04/29/install-freeipa-server-and-replica-on-centos-7">CentOS 7 安装 FreeIPA 主从复制</a></li><li><a href="https://computingforgeeks.com/how-to-install-and-configure-freeipa-server-on-ubuntu-18-04-ubuntu-16-04/">https://computingforgeeks.com/how-to-install-and-configure-freeipa-server-on-ubuntu-18-04-ubuntu-16-04/</a></li></ul><h1 id="Ubuntu18-安装-FreeIPA-Server"><a href="#Ubuntu18-安装-FreeIPA-Server" class="headerlink" title="Ubuntu18 安装 FreeIPA Server"></a>Ubuntu18 安装 FreeIPA Server</h1><blockquote><p>Ubuntu18 + 4vCPU + 4G</p></blockquote><h2 id="Profile-1"><a href="#Profile-1" class="headerlink" title="Profile"></a>Profile</h2><ul><li> ip: 192.168.128.121</li><li> kerberos realm: SONNYHCL.TOP</li><li> dns domain: sonnyhcl.top</li><li> admin server: ipa.sonnyhcl.top</li><li> with DNS: yes</li><li> forwarder: 127.0.0.1, 202.120.224.6, 202.120.224.26</li></ul><h2 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h2><h3 id="配置机器名-hostname-1"><a href="#配置机器名-hostname-1" class="headerlink" title="配置机器名 hostname"></a>配置机器名 hostname</h3><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="string">sudo</span> <span class="string">hostnamectl</span> <span class="built_in">set-hostname</span> <span class="string">ipa</span>.<span class="string">sonnyhcl</span>.<span class="string">top</span></span><br><span class="line"><span class="string"></span>$ <span class="string">hostname</span> -<span class="string">f</span></span><br><span class="line"><span class="string">ipa</span>.<span class="string">sonnyhcl</span>.<span class="string">top</span></span><br></pre></td></tr></table></figure><h3 id="配置-etc-hosts-1"><a href="#配置-etc-hosts-1" class="headerlink" title="配置 /etc/hosts"></a>配置 /etc/hosts</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &lt;ip fqdn shortname&gt;</span></span><br><span class="line">$ echo <span class="string">&quot;192.168.128.121 ipa.sonnyhcl.top ipa&quot;</span> |  sudo tee -a <span class="regexp">/etc/</span>hosts</span><br></pre></td></tr></table></figure><h3 id="配置随机数硬件加速-1"><a href="#配置随机数硬件加速-1" class="headerlink" title="配置随机数硬件加速"></a>配置随机数硬件加速</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> sudo apt update <span class="literal">-y</span></span><br><span class="line"><span class="variable">$</span> sudo apt install rng<span class="literal">-tools</span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">echo</span> <span class="string">&quot;HRNGDEVICE=/dev/urandom&quot;</span> | sudo <span class="built_in">tee</span> <span class="literal">-a</span> /etc/defaults/rng<span class="literal">-tools</span></span><br><span class="line"><span class="variable">$</span> sudo systemctl enable rng<span class="literal">-tools</span></span><br><span class="line"><span class="variable">$</span> sudo systemctl <span class="built_in">start</span> rng<span class="literal">-tools</span></span><br></pre></td></tr></table></figure><h3 id="下载-FreeIPA-Server-1"><a href="#下载-FreeIPA-Server-1" class="headerlink" title="下载 FreeIPA-Server"></a>下载 FreeIPA-Server</h3><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install -y freeipa-<span class="keyword">server</span></span><br></pre></td></tr></table></figure><p>安装过程中会依次让你输入之前 Profile 中定义的三个参数</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-  kerberos realm: SONNYHCL.TOP</span><br><span class="line">-  dns domain: sonnyhcl.<span class="attribute">top</span></span><br><span class="line">-  admin server: ipa<span class="selector-class">.sonnyhcl</span>.<span class="attribute">top</span></span><br></pre></td></tr></table></figure><h3 id="配置-FreeIPA-Server-1"><a href="#配置-FreeIPA-Server-1" class="headerlink" title="配置 FreeIPA-Server"></a>配置 FreeIPA-Server</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ipa-<span class="keyword">server</span>-install <span class="comment">--allow-zone-overlap</span></span><br><span class="line"># 接下来要输入参数如下</span><br><span class="line">- <span class="keyword">Do</span> you want <span class="keyword">to</span> configure integrated DNS (BIND)? [<span class="keyword">no</span>]: yes</span><br><span class="line">- <span class="keyword">Server</span> host <span class="type">name</span> [ipa.sonnyhcl.top]: &lt;Enter&gt;</span><br><span class="line">- Please confirm the <span class="keyword">domain</span> <span class="type">name</span> [sonnyhcl.top]: &lt;Enter&gt;</span><br><span class="line">- Please provide a realm <span class="type">name</span> [SONNYHCL.TOP]: &lt;Enter&gt;</span><br><span class="line">- Directory Manager <span class="keyword">password</span>: &lt;secure <span class="keyword">password</span>&gt;</span><br><span class="line">- <span class="keyword">Password</span> (confirm): &lt;secure <span class="keyword">password</span>&gt;</span><br><span class="line">- IPA <span class="keyword">admin</span> <span class="keyword">password</span>: &lt;secure <span class="keyword">password</span>&gt;</span><br><span class="line">- <span class="keyword">Password</span> (confirm): &lt;secure <span class="keyword">password</span>&gt;</span><br></pre></td></tr></table></figure><blockquote><p>详细安装记录见附录</p></blockquote><h3 id="Ubuntu-Patch"><a href="#Ubuntu-Patch" class="headerlink" title="Ubuntu Patch"></a>Ubuntu Patch</h3><blockquote><p>这几个都是FreeIPA在ubuntu上遇到的兼容性问题的修补方法</p></blockquote><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo touch <span class="regexp">/etc/</span>krb5kdc/kadm5.acl</span><br><span class="line">$ sudo chmod +x <span class="regexp">/var/</span>lib/krb5kdc</span><br><span class="line">$ echo <span class="string">&quot;session optional pam_mkhomedir.so&quot;</span> | sudo tee -a <span class="regexp">/etc/</span>pam.d/common-session</span><br><span class="line">$ sudo pam-auth-update</span><br><span class="line"><span class="comment"># 选 create home dir when first login</span></span><br></pre></td></tr></table></figure><h2 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h2><h3 id="测试-kerberos-1"><a href="#测试-kerberos-1" class="headerlink" title="测试 kerberos"></a>测试 kerberos</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kinit admin</span><br><span class="line">Password for admin<span class="keyword">@SONNYHCL</span>.<span class="attribute">TOP</span>:</span><br><span class="line">$ klist</span><br><span class="line">Ticket <span class="attribute">cache</span>: <span class="attribute">KEYRING</span>:<span class="attribute">persistent</span>:<span class="number">0</span>:<span class="number">0</span></span><br><span class="line">Default <span class="attribute">principal</span>: admin<span class="keyword">@SONNYHCL</span>.TOP</span><br><span class="line"></span><br><span class="line">Valid starting     Expires            Service principal</span><br><span class="line"><span class="number">06</span>/<span class="number">29</span>/<span class="number">18</span> <span class="number">22</span>:<span class="number">52</span>:<span class="number">40</span>  <span class="number">06</span>/<span class="number">30</span>/<span class="number">18</span> <span class="number">22</span>:<span class="number">52</span>:<span class="number">36</span>  krbtgt/SONNYHCL.TOP<span class="keyword">@SONNYHCL</span>.TOP</span><br></pre></td></tr></table></figure><h3 id="测试-ipa-1"><a href="#测试-ipa-1" class="headerlink" title="测试 ipa"></a>测试 ipa</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ ipa user-find admin</span><br><span class="line">--------------</span><br><span class="line">1 user matched</span><br><span class="line">--------------</span><br><span class="line"></span><br><span class="line"><span class="code">  User login: admin</span></span><br><span class="line"><span class="code">  Last name: Administrator</span></span><br><span class="line"><span class="code">  Home directory: /home/admin</span></span><br><span class="line"><span class="code">  Login shell: /bin/bash</span></span><br><span class="line"><span class="code">  Principal alias: admin@COMPUTINGFORGEEKS.COM</span></span><br><span class="line"><span class="code">  UID: 1506000000</span></span><br><span class="line"><span class="code">  GID: 1506000000</span></span><br><span class="line"><span class="code">  Account disabled: False</span></span><br><span class="line"><span class="code">  ----------------------------</span></span><br><span class="line"><span class="code">  Number of entries returned 1</span></span><br><span class="line"><span class="code">  ----------------------------</span></span><br><span class="line">$ sudo ipactl status</span><br><span class="line">Directory Service: RUNNING</span><br><span class="line">krb5kdc Service: RUNNING</span><br><span class="line">kadmin Service: RUNNING</span><br><span class="line">named Service: RUNNING</span><br><span class="line">httpd Service: RUNNING</span><br><span class="line">ipa-custodia Service: RUNNING</span><br><span class="line">ntpd Service: RUNNING</span><br><span class="line">pki-tomcatd Service: RUNNING</span><br><span class="line">ipa-otpd Service: RUNNING</span><br><span class="line">ipa-dnskeysyncd Service: RUNNING</span><br><span class="line">ipa: INFO: The ipactl command was successful</span><br></pre></td></tr></table></figure><h3 id="测试-Web-UI-1"><a href="#测试-Web-UI-1" class="headerlink" title="测试 Web UI"></a>测试 Web UI</h3><p>如果在虚拟机中部署，在宿主机访问，请确保你的宿主机　hosts　里面也写入了第2步中的域名解析</p><p>访问<code>https://ipa.soaringlao.top/ipa/ui</code>，选择　高级　-&gt;　继续访问　即可跳过浏览器对 https 证书的质疑。输入刚刚创建的<code>admin</code>账户密码即可进入 Web 管理界面。</p><h2 id="参考链接-1"><a href="#参考链接-1" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://qizhanming.com/blog/2019/04/29/install-freeipa-server-and-replica-on-centos-7">CentOS 7 安装 FreeIPA 主从复制</a></li><li><a href="https://computingforgeeks.com/how-to-install-and-configure-freeipa-server-on-ubuntu-18-04-ubuntu-16-04/">https://computingforgeeks.com/how-to-install-and-configure-freeipa-server-on-ubuntu-18-04-ubuntu-16-04/</a></li><li></li><li><a href="https://github.com/freeipa/ansible-freeipa">FreeIPA ansible</a></li></ul><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">To</span> accept the <span class="keyword">default</span> options shown <span class="keyword">in</span> square brackets, just press Enter <span class="keyword">key</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Do</span> you want <span class="keyword">to</span> configure integrated DNS (BIND)? [no]: yes</span><br><span class="line"></span><br><span class="line">Enter the fully qualified domain name <span class="keyword">of</span> the computer</span><br><span class="line"></span><br><span class="line"><span class="keyword">on</span> which you<span class="comment">&#x27;re setting up server software. Using the form</span></span><br><span class="line"></span><br><span class="line">&lt;hostname&gt;.&lt;domainname&gt;</span><br><span class="line"></span><br><span class="line"><span class="symbol">Example:</span> master.example.com.</span><br><span class="line"></span><br><span class="line">Server host name [ipa.sonnyhcl.top]: &lt;Enter&gt;</span><br><span class="line">The domain name has been determined based <span class="keyword">on</span> the host name.</span><br><span class="line">Please confirm the domain name [sonnyhcl.top]: &lt;Enter&gt;</span><br><span class="line">The kerberos protocol requires a Realm name <span class="keyword">to</span> be defined.</span><br><span class="line">This <span class="built_in">is</span> typically the domain name converted <span class="keyword">to</span> uppercase.</span><br><span class="line">Please provide a realm name [SONNYHCL.TOP]: &lt;Enter&gt;</span><br><span class="line">Certain directory server operations require an administrative user.</span><br><span class="line">This user <span class="built_in">is</span> referred <span class="keyword">to</span> <span class="keyword">as</span> the Directory Manager <span class="built_in">and</span> has full access</span><br><span class="line"><span class="keyword">to</span> the Directory <span class="keyword">for</span> system management tasks <span class="built_in">and</span> will be added <span class="keyword">to</span> the</span><br><span class="line">instance <span class="keyword">of</span> directory server created <span class="keyword">for</span> IPA.</span><br><span class="line">The password must be at least <span class="number">8</span> characters <span class="type">long</span></span><br><span class="line">Directory Manager password: &lt;secure password&gt;</span><br><span class="line">Password (confirm): &lt;secure password&gt;</span><br><span class="line">The IPA server requires an administrative user, named <span class="comment">&#x27;admin&#x27;.</span></span><br><span class="line">This user <span class="built_in">is</span> a regular system account used <span class="keyword">for</span> IPA server administration.</span><br><span class="line"></span><br><span class="line">IPA admin password: &lt;secure password&gt;</span><br><span class="line">Password (confirm): &lt;secure password&gt;</span><br><span class="line"></span><br><span class="line">The IPA Master Server will be configured <span class="keyword">with</span>:</span><br><span class="line"></span><br><span class="line"><span class="symbol">Hostname:</span>    ipa.sonnyhcl.top</span><br><span class="line">IP address(es): <span class="number">192.168</span>.<span class="number">128.121</span></span><br><span class="line">Domain name: sonnyhcl.top</span><br><span class="line">Realm name:  SONNYHCL.TOP</span><br><span class="line"></span><br><span class="line">The CA will be configured <span class="keyword">with</span>:</span><br><span class="line"></span><br><span class="line">Subject DN:   CN=Certificate Authority,O=SONNYHCL.TOP</span><br><span class="line">Subject base: O=SONNYHCL.TOP</span><br><span class="line"><span class="symbol">Chaining:</span>  self-signed</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">Continue</span> <span class="keyword">to</span> configure the system <span class="keyword">with</span> these values? [no]: yes</span><br><span class="line"></span><br><span class="line">...output cut...</span><br><span class="line">Client configuration complete.</span><br><span class="line"></span><br><span class="line">The ipa-client-install command was successful</span><br><span class="line"></span><br><span class="line">Setup complete</span><br><span class="line"></span><br><span class="line"><span class="keyword">Next</span> steps:</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. You must make sure these network ports are open: </span><br><span class="line">    TCP Ports: </span><br><span class="line">    * <span class="number">80</span>, <span class="number">443</span>: HTTP/HTTPS </span><br><span class="line">    * <span class="number">389</span>, <span class="number">636</span>: LDAP/LDAPS </span><br><span class="line">    * <span class="number">88</span>, <span class="number">464</span>: kerberos UDP Ports: </span><br><span class="line">    * <span class="number">88</span>, <span class="number">464</span>: kerberos </span><br><span class="line">    * <span class="number">123</span>: ntp </span><br><span class="line"><span class="number">2</span>. You can now obtain a kerberos ticket <span class="keyword">using</span> the command: <span class="comment">&#x27;kinit admin&#x27; </span></span><br><span class="line">This ticket will allow you <span class="keyword">to</span> use the IPA tools (e.g., ipa user-add) <span class="built_in">and</span> the web user <span class="keyword">interface</span>.</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;这个系列是笔者在为实验室搭建本地私有云的过程中所记载的笔记,看起来会比较杂乱 :)&lt;/p&gt;
&lt;p&gt;当我们搭建本地私有云的时候,首先要考虑的就是一套统一的用户认证管理系统.&lt;/p&gt;</summary>
    
    
    
    <category term="Tech" scheme="https://sonnyhcl.com/categories/Tech/"/>
    
    
    <category term="on-premise-cloud" scheme="https://sonnyhcl.com/tags/on-premise-cloud/"/>
    
    <category term="FreeIPA" scheme="https://sonnyhcl.com/tags/FreeIPA/"/>
    
  </entry>
  
  <entry>
    <title>搭建本地私有云之时钟对准NTP</title>
    <link href="https://sonnyhcl.com/on-premise-ntp-server/"/>
    <id>https://sonnyhcl.com/on-premise-ntp-server/</id>
    <published>2019-10-17T03:16:43.000Z</published>
    <updated>2019-10-17T03:16:43.000Z</updated>
    
    <content type="html"><![CDATA[<p>这个系列是笔者在为实验室搭建本地私有云的过程中所记载的笔记,看起来会比较杂乱 :)</p><p>在搭建本地私有云的过程中,保证所有系统之间的时钟同步是非常重要的,因此为本地私有云维护一个专门的NTP server也是非常有必要的</p><span id="more"></span><h2 id="搭建NTP服务"><a href="#搭建NTP服务" class="headerlink" title="搭建NTP服务"></a>搭建NTP服务</h2><h3 id="安装NTP"><a href="#安装NTP" class="headerlink" title="安装NTP"></a>安装NTP</h3><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ntp</span><br></pre></td></tr></table></figure><h3 id="修改ntp-server虚拟主机的配置文件"><a href="#修改ntp-server虚拟主机的配置文件" class="headerlink" title="修改ntp server虚拟主机的配置文件"></a>修改ntp server虚拟主机的配置文件</h3><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/ntp.conf</span><br><span class="line">-----------------------</span><br><span class="line">restrict -4 default notrap nomodify nopeer</span><br><span class="line">restrict -6 default notrap nomodify nopeer</span><br><span class="line"></span><br><span class="line">restrict 127.0.0.1</span><br><span class="line">restrict ::1</span><br><span class="line"></span><br><span class="line">driftfile /var/lib/ntp/drift/ntp.drift # path for drift file</span><br><span class="line"></span><br><span class="line">logfile   /var/log/ntp# alternate log file</span><br><span class="line">logconfig =syncall +clockall +sysevents</span><br><span class="line"></span><br><span class="line">keys /etc/ntp.keys# path for keys file</span><br><span class="line">trustedkey 1# define trusted keys</span><br><span class="line">requestkey 1# key (7) for accessing server variables</span><br><span class="line">controlkey 1# key (6) for accessing server variables</span><br><span class="line"></span><br><span class="line">restrict 0.cn.pool.ntp.org notrap nomodify noquery</span><br><span class="line">pool 0.cn.pool.ntp.org iburst minpoll 4 maxpoll 7</span><br><span class="line">restrict 1.cn.pool.ntp.org notrap nomodify noquery</span><br><span class="line">pool 1.cn.pool.ntp.org iburst minpoll 4 maxpoll 7</span><br><span class="line">restrict 2.cn.pool.ntp.org notrap nomodify noquery</span><br><span class="line">pool 2.cn.pool.ntp.org iburst minpoll 4 maxpoll 7</span><br><span class="line">restrict 3.cn.pool.ntp.org notrap nomodify noquery</span><br><span class="line">pool 3.cn.pool.ntp.org iburst minpoll 4 maxpoll 7</span><br><span class="line"></span><br><span class="line">server ntp.fudan.edu.cn iburst minpoll 4 maxpoll 7</span><br><span class="line">server time1.google.com iburst minpoll 4 maxpoll 7</span><br><span class="line">server time2.google.com iburst minpoll 4 maxpoll 7</span><br><span class="line">server time3.google.com iburst minpoll 4 maxpoll 7</span><br><span class="line">server time4.google.com iburst minpoll 4 maxpoll 7</span><br><span class="line">-----------------------</span><br></pre></td></tr></table></figure><h3 id="配置ntp服务"><a href="#配置ntp服务" class="headerlink" title="配置ntp服务"></a>配置ntp服务</h3><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable ntp.service</span><br><span class="line">sudo systemctl start ntp.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> or</span></span><br><span class="line">sudo systemctl restart ntp.service</span><br></pre></td></tr></table></figure><h3 id="查看NTP时间对准情况"><a href="#查看NTP时间对准情况" class="headerlink" title="查看NTP时间对准情况"></a>查看NTP时间对准情况</h3><blockquote><p>重点关注offset和jitter两个参数,一般小于0.1就算校准了</p></blockquote><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">watch -n 1 ntpq -pn</span><br><span class="line">-----------------------</span><br><span class="line">remote           refid              st  t   when poll   reach   delay   offset  jitter</span><br><span class="line">======================================================================================</span><br><span class="line">*ntp.sonnyhcl. 23.71.59.65        3   u   18   32     377     0.364   -0.250   0.043</span><br><span class="line">----------------------</span><br></pre></td></tr></table></figure><h2 id="NTP客户端配置"><a href="#NTP客户端配置" class="headerlink" title="NTP客户端配置"></a>NTP客户端配置</h2><p>当我们在本地私有云中新添加一个虚拟机,需要为它配置对应的ntp server时,以chrony为例我们需要做</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/chrony.conf</span><br><span class="line">-------------------------</span><br><span class="line">server ntp.sonnyhcl.top iburst minpoll 4 maxpoll 7</span><br><span class="line">-------------------------</span><br></pre></td></tr></table></figure><p>然后查看时钟对准情况</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">watch</span> -n <span class="number">1</span> ntpq -pn</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;这个系列是笔者在为实验室搭建本地私有云的过程中所记载的笔记,看起来会比较杂乱 :)&lt;/p&gt;
&lt;p&gt;在搭建本地私有云的过程中,保证所有系统之间的时钟同步是非常重要的,因此为本地私有云维护一个专门的NTP server也是非常有必要的&lt;/p&gt;</summary>
    
    
    
    <category term="Tech" scheme="https://sonnyhcl.com/categories/Tech/"/>
    
    
    <category term="on-premise-cloud" scheme="https://sonnyhcl.com/tags/on-premise-cloud/"/>
    
    <category term="ntp" scheme="https://sonnyhcl.com/tags/ntp/"/>
    
  </entry>
  
  <entry>
    <title>LVM Cache折腾杂记（一）</title>
    <link href="https://sonnyhcl.com/use-lvm-cache/"/>
    <id>https://sonnyhcl.com/use-lvm-cache/</id>
    <published>2019-05-08T11:34:25.000Z</published>
    <updated>2019-05-08T11:34:25.000Z</updated>
    
    <content type="html"><![CDATA[<p>这篇文章介绍的是利用SSD给HDD做LVM Cache加速，SSD容量小但是速度快，HDD容量大但是延迟高，我们可以利用一个小SSD给HDD缓存加速访问速度。</p><span id="more"></span><h2 id="LVM存储池"><a href="#LVM存储池" class="headerlink" title="LVM存储池"></a>LVM存储池</h2><ul><li>系统已安装好并分好区如下所示，其中sda为HDD，sdb为SSD</li><li>SSD上除了已分配的系统root、home之外，还有少量空间富裕</li><li>HDD大容量硬盘做数据盘挂载到/var上，SSD富裕部分做Cache</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">clhu@G7:~$ lsblk</span><br><span class="line">NAME               MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda                  8:0    0 931.5G  0 disk </span><br><span class="line">└─sda1               8:1    0 931.5G  0 part </span><br><span class="line">sdb                  8:16   0   477G  0 disk </span><br><span class="line">├─sdb1               8:17   0   512M  0 part /boot/efi</span><br><span class="line">├─sdb2               8:18   0     2G  0 part /boot</span><br><span class="line">├─sdb3               8:19   0    32G  0 part [SWAP]</span><br><span class="line">├─sdb4               8:20   0   100G  0 part /home</span><br><span class="line">├─sdb5               8:21   0    60G  0 part /</span><br><span class="line">└─sdb6               8:22   0 282.4G  0 part </span><br></pre></td></tr></table></figure><h3 id="添加物理卷"><a href="#添加物理卷" class="headerlink" title="添加物理卷"></a>添加物理卷</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo pvcreate /dev/sda1</span><br><span class="line">sudo pvcreate /dev/sdb6</span><br></pre></td></tr></table></figure><h3 id="添加卷组g7"><a href="#添加卷组g7" class="headerlink" title="添加卷组g7"></a>添加卷组g7</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo vgcreate g7 /dev/sda1</span><br><span class="line">sudo vgextend g7 /dev/sdb6</span><br></pre></td></tr></table></figure><h3 id="添加逻辑卷"><a href="#添加逻辑卷" class="headerlink" title="添加逻辑卷"></a>添加逻辑卷</h3><p>var为存储卷，cache为缓存卷，meta为缓冲卷索引，其中cache:meta不能大于1000:1，meta最小为8M。最后要注意的是，不要分配完pv内所有空间，要留一点给lvm创建自己的元数据索引。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo lvcreate -l 100%FREE -n var g7 /dev/sda1</span><br><span class="line">sudo lvcreate -L 280G -n cache g7 /dev/sdb6</span><br><span class="line">sudo lvcreate -L 300M -n meta g7 /dev/sdb6</span><br></pre></td></tr></table></figure><h3 id="添加缓存池"><a href="#添加缓存池" class="headerlink" title="添加缓存池"></a>添加缓存池</h3><p>注意meta和cache顺序</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo lvconvert --<span class="built_in">type</span> cache-pool --poolmetadata g7/meta g7/cache</span><br></pre></td></tr></table></figure><h3 id="绑定缓存池与存储卷"><a href="#绑定缓存池与存储卷" class="headerlink" title="绑定缓存池与存储卷"></a>绑定缓存池与存储卷</h3><ul><li>writeback会在写入cache完成后，再写入var中</li><li>writethrough会在写入cache的同时，写入var，写入var慢于cache，writethrough写入较慢，但数据不易丢失</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo lvconvert --<span class="built_in">type</span> cache --cachepool g7/cache --cachemode writethrough g7/var</span><br></pre></td></tr></table></figure><h3 id="中间成果"><a href="#中间成果" class="headerlink" title="中间成果"></a>中间成果</h3><p>应该可以看到如下所示结构</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">clhu@G7:~$ sudo pvs -a</span><br><span class="line">  PV           VG Fmt  Attr PSize    PFree</span><br><span class="line">  /dev/g7/var         ---        0     0 </span><br><span class="line">  /dev/sda1    g7 lvm2 a--  &lt;931.51g    0 </span><br><span class="line">  /dev/sdb1            ---        0     0 </span><br><span class="line">  /dev/sdb2            ---        0     0 </span><br><span class="line">  /dev/sdb3            ---        0     0 </span><br><span class="line">  /dev/sdb4            ---        0     0 </span><br><span class="line">  /dev/sdb5            ---        0     0 </span><br><span class="line">  /dev/sdb6    g7 lvm2 a--  &lt;282.44g 1.85g</span><br><span class="line">clhu@G7:~$ sudo lvs</span><br><span class="line">  LV   VG Attr       LSize    Pool    Origin       Data%  Meta%  Move Log Cpy%Sync Convert</span><br><span class="line">  var g7 Cwi-aoC--- &lt;931.51g [cache] [var_corig] 1.13   3.61            0.00            </span><br><span class="line">clhu@G7:~$ sudo lvs -a</span><br><span class="line">  LV              VG Attr       LSize    Pool    Origin       Data%  Meta%  Move Log Cpy%Sync Convert</span><br><span class="line">  [cache]         g7 Cwi---C---  280.00g                      1.14   3.61            0.00            </span><br><span class="line">  [cache_cdata]   g7 Cwi-ao----  280.00g                                                             </span><br><span class="line">  [cache_cmeta]   g7 ewi-ao----  300.00m                                                             </span><br><span class="line">  var            g7 Cwi-aoC--- &lt;931.51g [cache] [var_corig] 1.14   3.61            0.00            </span><br><span class="line">  [var_corig]    g7 owi-aoC--- &lt;931.51g                                                             </span><br><span class="line">  [lvol0_pmspare] g7 ewi-------  300.00m           </span><br></pre></td></tr></table></figure><h3 id="格式化"><a href="#格式化" class="headerlink" title="格式化"></a>格式化</h3><p>此时<code>g7/var</code>在系统中被映射为<code>/dev/mapper/g7-var</code>，它可以被视作一块未格式化的新盘，下面开始格式化</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkfs.ext4 /dev/mapper/g7-var</span><br></pre></td></tr></table></figure><h3 id="安装缓存工具包"><a href="#安装缓存工具包" class="headerlink" title="安装缓存工具包"></a>安装缓存工具包</h3><p>否则在重新开机的时候会发现系统无法识别新挂载的/var</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt <span class="keyword">install</span> -y thin-provisioning-tools</span><br></pre></td></tr></table></figure><h2 id="挂载-var"><a href="#挂载-var" class="headerlink" title="挂载/var"></a>挂载/var</h2><h3 id="拷贝-var到新盘中"><a href="#拷贝-var到新盘中" class="headerlink" title="拷贝/var到新盘中"></a>拷贝/var到新盘中</h3><p>这一步是因为我们希望把数据盘挂载在｀/var｀上,需要迁移已有的/var上的数据,否则可以跳过这一步</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 挂载g7-var</span></span><br><span class="line">sudo mkdir -p /mnt/var</span><br><span class="line">sudo mount /dev/mapper/g7-var /mnt/var</span><br><span class="line"><span class="comment"># 带属性拷贝</span></span><br><span class="line">sudo rsync -avHPSAX /var/ /mnt/var/</span><br><span class="line"><span class="comment"># 检查</span></span><br><span class="line">sudo diff -r /var/ /mnt/var/</span><br><span class="line"><span class="comment"># 卸载新盘</span></span><br><span class="line">sudo umount /mnt/var</span><br></pre></td></tr></table></figure><h3 id="修改fstab"><a href="#修改fstab" class="headerlink" title="修改fstab"></a>修改fstab</h3><p>在fstab末尾加上/var的挂载</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/dev/m</span>apper<span class="regexp">/g7-var   /</span>var  ext4  defaults  <span class="number">0</span>   <span class="number">0</span></span><br></pre></td></tr></table></figure><h3 id="挂载-var到新盘上"><a href="#挂载-var到新盘上" class="headerlink" title="挂载/var到新盘上"></a>挂载/var到新盘上</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mv /var /var_old</span><br><span class="line">sudo mkdir /var</span><br><span class="line">sudo mount /var</span><br></pre></td></tr></table></figure><p>此时新盘应该已经挂载好了/var,查看mount命令应如下所示</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clhu@G7:~$ mount</span><br><span class="line">/dev/mapper/g7-var on /var <span class="built_in">type</span> ext4 (rw,relatime,stripe=80)</span><br></pre></td></tr></table></figure><h3 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 尝试一下mount fstab</span></span><br><span class="line">sudo mount</span><br><span class="line"><span class="comment"># 重启才是硬道理</span></span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure><h2 id="最终成果"><a href="#最终成果" class="headerlink" title="最终成果"></a>最终成果</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">clhu@G7:~$ df -hT</span><br><span class="line">Filesystem          Type      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sdb5           ext4       59G  5.7G   51G  11% /</span><br><span class="line">/dev/sdb2           ext4      2.0G  168M  1.7G  10% /boot</span><br><span class="line">/dev/sdb4           ext4       98G   92M   93G   1% /home</span><br><span class="line">/dev/sdb1           vfat      511M  6.1M  505M   2% /boot/efi</span><br><span class="line">/dev/mapper/g7-var ext4      916G  1.1G  869G   1% /var</span><br><span class="line">clhu@G7:~$ lsblk</span><br><span class="line">NAME               MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda                  8:0    0 931.5G  0 disk </span><br><span class="line">└─sda1               8:1    0 931.5G  0 part </span><br><span class="line">  └─g7-var_corig  253:2    0 931.5G  0 lvm  </span><br><span class="line">    └─g7-var      253:3    0 931.5G  0 lvm  /var</span><br><span class="line">sdb                  8:16   0   477G  0 disk </span><br><span class="line">├─sdb1               8:17   0   512M  0 part /boot/efi</span><br><span class="line">├─sdb2               8:18   0     2G  0 part /boot</span><br><span class="line">├─sdb3               8:19   0    32G  0 part [SWAP]</span><br><span class="line">├─sdb4               8:20   0   100G  0 part /home</span><br><span class="line">├─sdb5               8:21   0    60G  0 part /</span><br><span class="line">└─sdb6               8:22   0 282.4G  0 part </span><br><span class="line">  ├─g7-cache_cvar 253:0    0   280G  0 lvm  </span><br><span class="line">  │ └─g7-var      253:3    0 931.5G  0 lvm  /var</span><br><span class="line">  └─g7-cache_cmeta 253:1    0   300M  0 lvm  </span><br><span class="line">    └─g7-var      253:3    0 931.5G  0 lvm  /var</span><br></pre></td></tr></table></figure><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="http://www.lerrigatto.com/move-var-to-a-new-partition-with-lvm/">move-var-to-a-new-partition-with-lvm/</a></li><li><a href="https://blog.csdn.net/gaobudong1234/article/details/78270974">Linux LVM cache的应用</a></li></ul><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;这篇文章介绍的是利用SSD给HDD做LVM Cache加速，SSD容量小但是速度快，HDD容量大但是延迟高，我们可以利用一个小SSD给HDD缓存加速访问速度。&lt;/p&gt;</summary>
    
    
    
    <category term="Tech" scheme="https://sonnyhcl.com/categories/Tech/"/>
    
    
    <category term="LVM" scheme="https://sonnyhcl.com/tags/LVM/"/>
    
    <category term="Cache" scheme="https://sonnyhcl.com/tags/Cache/"/>
    
    <category term="SSD" scheme="https://sonnyhcl.com/tags/SSD/"/>
    
  </entry>
  
  <entry>
    <title>使用树莓派搭建无线打印机</title>
    <link href="https://sonnyhcl.com/share-printer-using-rpi/"/>
    <id>https://sonnyhcl.com/share-printer-using-rpi/</id>
    <published>2019-05-01T11:10:41.000Z</published>
    <updated>2019-05-01T11:10:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>办公室里的打印机的网口莫名其妙地坏掉了，只剩下USB打印还能用。总不能打印什么都端电脑过去打印机那边打吧，这时候就需要一个树莓派，来干点共享网络打印机的功能了。</p><span id="more"></span><h2 id="物品准备"><a href="#物品准备" class="headerlink" title="物品准备"></a>物品准备</h2><ul><li>一个树莓派，2代3代都可以</li><li>一张至少16GB的TF卡</li><li>一个TF读卡器</li><li>一根网线</li><li>一个可以（或者是只能）通过USB打印的打印机</li></ul><h2 id="树莓派系统安装"><a href="#树莓派系统安装" class="headerlink" title="树莓派系统安装"></a>树莓派系统安装</h2><p>区别于官方提供的镜像版本，我们将会采用一个专门给树莓派定制的镜像版本<code>Hypriot</code>。它在镜像内预先安装了armhf版本的docker，并且采用cloud-init在烧写的时候来初始化初始配置。用cloud-init有多爽呢，一般情况下我们得至少有个键鼠套装+显示屏才能完成树莓派的初步网络配置，而现在只需要在烧录镜像的时候指定userdata就可以完成初步的网络配置、用户管理等。</p><ul><li><a href="http://blog.hypriot.com/downloads/">Hypriot镜像下载地址</a></li><li><a href="https://github.com/hypriot/flash">命令行烧录工具flash</a></li></ul><p>本文所有操作除了在树莓派上，其它均在<code>ubuntu 16.04</code>下进行操作</p><h3 id="树莓派系统镜像"><a href="#树莓派系统镜像" class="headerlink" title="树莓派系统镜像"></a>树莓派系统镜像</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="regexp">//gi</span>thub.com<span class="regexp">/hypriot/im</span>age-builder-rpi<span class="regexp">/releases/</span>download<span class="regexp">/v1.10.0/</span>hypriotos-rpi-v1.<span class="number">10.0</span>.img.zip</span><br></pre></td></tr></table></figure><h3 id="烧录工具flash"><a href="#烧录工具flash" class="headerlink" title="烧录工具flash"></a>烧录工具flash</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y pv curl python-pip unzip hdparm</span><br><span class="line">git clone https:<span class="regexp">//gi</span>thub.com<span class="regexp">/hypriot/</span>flash</span><br><span class="line">cd flash</span><br><span class="line">chmod +x flash</span><br><span class="line">sudo cp flash <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>flash</span><br></pre></td></tr></table></figure><h3 id="自定义烧录参数"><a href="#自定义烧录参数" class="headerlink" title="自定义烧录参数"></a>自定义烧录参数</h3><p>烧录tf卡之前，首先需要定制一下cloud-init要用到的userdata文件。flash本身有提供几个sample模板，包含事先预置ssh公钥、配置静态ip、配置wifi连接密码等多种花式操作。这是我用来配置静态IP的模板，你可以根据自己需要修改当中的静态IP。</p><blockquote><p>sample/static.yml</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cloud-config</span></span><br><span class="line"><span class="comment"># vim: syntax=yaml</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set your hostname here, the manage_etc_hosts will update the hosts file entries as well</span></span><br><span class="line"><span class="attr">hostname:</span> <span class="string">printer</span></span><br><span class="line"><span class="attr">manage_etc_hosts:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># don&#x27;t write debian.org into apt mirrors</span></span><br><span class="line"><span class="attr">apt_preserve_sources_list:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You could modify this for your own user information</span></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pirate</span></span><br><span class="line">    <span class="attr">gecos:</span> <span class="string">&quot;Hypriot Pirate&quot;</span></span><br><span class="line">    <span class="attr">sudo:</span> <span class="string">ALL=(ALL)</span> <span class="string">NOPASSWD:ALL</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">/bin/bash</span></span><br><span class="line">    <span class="attr">groups:</span> <span class="string">users,docker,video</span></span><br><span class="line">    <span class="attr">plain_text_passwd:</span> <span class="string">hypriot</span></span><br><span class="line">    <span class="attr">lock_passwd:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">ssh_pwauth:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">chpasswd:</span> &#123; <span class="attr">expire:</span> <span class="literal">false</span> &#125;</span><br><span class="line">    <span class="attr">ssh-authorized-keys:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ssh-ed25519</span> <span class="string">AAAAC3NzaC1lZDI1NTE5AAAAIPmU0KQcntkCUk4W61JjmGPVKo9+z2wDYjSKoVzLqGNG</span>  </span><br><span class="line"></span><br><span class="line"><span class="attr">package_upgrade:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Static IP address</span></span><br><span class="line"><span class="attr">write_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">content:</span> <span class="string">|</span></span><br><span class="line">      <span class="string">persistent</span></span><br><span class="line">      <span class="comment"># Generate Stable Private IPv6 Addresses instead of hardware based ones</span></span><br><span class="line">      <span class="string">slaac</span> <span class="string">private</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># static IP configuration:</span></span><br><span class="line">      <span class="string">interface</span> <span class="string">eth0</span></span><br><span class="line">      <span class="string">static</span> <span class="string">ip_address=10.xxx.245.106/23</span></span><br><span class="line">      <span class="string">static</span> <span class="string">routers=10.xxx.244.1</span></span><br><span class="line">      <span class="string">static</span> <span class="string">domain_name_servers=202.120.224.6</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/dhcpcd.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># These commands will be ran once on first boot only</span></span><br><span class="line"><span class="attr">runcmd:</span></span><br><span class="line">  <span class="comment"># Pickup the hostname changes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;systemctl restart avahi-daemon&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="烧录TF卡"><a href="#烧录TF卡" class="headerlink" title="烧录TF卡"></a>烧录TF卡</h3><p>可以使用<code>sudo fdisk -l</code>或者<code>df -hT</code>命令查看待烧录的TF卡的盘符，这里假设它为<code>/dev/sdx</code>。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">flash</span> --userdata sample/static.yml -d /dev/sdx hypriotos-rpi-v<span class="number">1</span>.<span class="number">10</span>.<span class="number">0</span>.img.zip</span><br></pre></td></tr></table></figure><p>烧录完就可以直接通过ssh直接连接到树莓派上</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">clhu@t5 <span class="function">~&gt;</span> ssh pirate@<span class="number">10.xxx</span>.<span class="number">245.130</span></span><br><span class="line">Linux pi <span class="number">4.14</span>.<span class="number">98</span>-v7+ <span class="comment">#1200 SMP Tue Feb 12 20:27:48 GMT 2019 armv7l</span></span><br><span class="line"></span><br><span class="line">HypriotOS (Debian GNU/Linux <span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">The programs included <span class="keyword">with</span> the Debian GNU/Linux system are free software;</span><br><span class="line">the exact distribution terms <span class="keyword">for</span> each program are described <span class="keyword">in</span> the</span><br><span class="line">individual files <span class="keyword">in</span> <span class="regexp">/usr/share/doc/</span>*/copyright.</span><br><span class="line"></span><br><span class="line">Debian GNU/Linux comes <span class="keyword">with</span> ABSOLUTELY NO WARRANTY, <span class="keyword">to</span> the extent</span><br><span class="line">permitted <span class="keyword">by</span> applicable law.</span><br><span class="line">Last login: Wed May  <span class="number">1</span> <span class="number">16</span>:<span class="number">01</span>:<span class="number">55</span> <span class="number">2019</span> <span class="keyword">from</span> <span class="number">10.131</span>.<span class="number">245.147</span></span><br><span class="line">HypriotOS/armv7: pirate@printer <span class="keyword">in</span> ~</span><br><span class="line">$ </span><br></pre></td></tr></table></figure><h2 id="CUPS开启共享打印机"><a href="#CUPS开启共享打印机" class="headerlink" title="CUPS开启共享打印机"></a>CUPS开启共享打印机</h2><blockquote><p>接下来在树莓派上进行操作</p></blockquote><h3 id="树莓派镜像源配置"><a href="#树莓派镜像源配置" class="headerlink" title="树莓派镜像源配置"></a>树莓派镜像源配置</h3><p>在安装软件包之前，首先需要配置一下对应的镜像源，这里主要<a href="https://mirrors.tuna.tsinghua.edu.cn/help/raspbian/">参考tuna的镜像源配置方法</a>，意外惊喜是该镜像源可以直接走v6 :)。</p><ul><li>编辑 <code>/etc/apt/sources.list</code> 文件，删除原文件所有内容，用以下内容取代：</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">deb http:<span class="regexp">//mi</span>rrors.tuna.tsinghua.edu.cn<span class="regexp">/raspbian/</span>raspbian/ stretch main non-free contrib</span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rrors.tuna.tsinghua.edu.cn<span class="regexp">/raspbian/</span>raspbian/ stretch main non-free contrib</span><br></pre></td></tr></table></figure><ul><li>编辑 <code>/etc/apt/sources.list.d/raspi.list</code> 文件，删除原文件所有内容，用以下内容取代：</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb http:<span class="regexp">//mi</span>rrors.tuna.tsinghua.edu.cn<span class="regexp">/raspberrypi/</span> stretch main</span><br></pre></td></tr></table></figure><ul><li>更新镜像源</li></ul><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo apt update</span></span><br></pre></td></tr></table></figure><h3 id="树莓派安装CUPS"><a href="#树莓派安装CUPS" class="headerlink" title="树莓派安装CUPS"></a>树莓派安装CUPS</h3><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 安装cups</span></span><br><span class="line">sudo apt install cups</span><br><span class="line"><span class="meta"># 启动cups服务</span></span><br><span class="line">sudo service cups start</span><br><span class="line"><span class="meta"># 将当前pirate用户添加进lpadmin用户组，这样才有权限管理631端口的打印机页面</span></span><br><span class="line">sudo usermod -a -G lpadmin pirate</span><br><span class="line"><span class="meta"># 设置允许远程控制</span></span><br><span class="line">sudo cupsctl --remote-any</span><br></pre></td></tr></table></figure><h3 id="CUPS服务配置"><a href="#CUPS服务配置" class="headerlink" title="CUPS服务配置"></a>CUPS服务配置</h3><p>cups服务启动之后，我们就可以通过网页来对cups服务进行配置，类似于<a href="">https://10.xxx.245.130:631</a>，如下图所示。</p><p><img src="cups.png" alt="cups"></p><p>依次点击其中的<code>Administration -&gt; Add Printer</code>页面，会让你输一下管理员密码，保证接下来的操作有足够权限。<br>接下来只需要一路continue即可，需要注意的是Sharing一定要记得勾选。</p><p><img src="sharing.png" alt="sharing"></p><h2 id="打印机使用"><a href="#打印机使用" class="headerlink" title="打印机使用"></a>打印机使用</h2><p>在笔者所用的Ubuntu中，只需要打开打印机设置页面，点击<code>+</code>按钮来添加一个打印机。这时候只需要输入打印机的IP地址，就可以看到打印机列表中出现了我们通过树莓派共享的网络打印机。</p><p><img src="linux.png" alt="linux"></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://www.jianshu.com/p/d3752c584e01">使用树莓派搭建无线打印机</a></li><li><a href="https://sspai.com/post/40997">如何正确地用树莓派共享打印机</a></li></ul><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;办公室里的打印机的网口莫名其妙地坏掉了，只剩下USB打印还能用。总不能打印什么都端电脑过去打印机那边打吧，这时候就需要一个树莓派，来干点共享网络打印机的功能了。&lt;/p&gt;</summary>
    
    
    
    <category term="Tech" scheme="https://sonnyhcl.com/categories/Tech/"/>
    
    
    <category term="Raspberry" scheme="https://sonnyhcl.com/tags/Raspberry/"/>
    
    <category term="RPI" scheme="https://sonnyhcl.com/tags/RPI/"/>
    
    <category term="HypriotOS" scheme="https://sonnyhcl.com/tags/HypriotOS/"/>
    
    <category term="Printer" scheme="https://sonnyhcl.com/tags/Printer/"/>
    
  </entry>
  
  <entry>
    <title>Hexo+GitHub搭建个人博客</title>
    <link href="https://sonnyhcl.com/hexo-github-page-blog/"/>
    <id>https://sonnyhcl.com/hexo-github-page-blog/</id>
    <published>2019-04-27T07:33:17.000Z</published>
    <updated>2019-04-27T07:33:17.000Z</updated>
    
    <content type="html"><![CDATA[<p>本着随便写点什么的想法，我开始搭建了这个博客站点。想着是越简单越好，越朴素越好，现成的GitHub Pages不用白不用，最好是能直接基于markdown就能生成页面，最终选择了GitHub Pages+Hexo+Next Mist+Travis CI的方案。</p><span id="more"></span><h2 id="技术方案"><a href="#技术方案" class="headerlink" title="技术方案"></a>技术方案</h2><h3 id="GitHub-Pages"><a href="#GitHub-Pages" class="headerlink" title="GitHub Pages"></a>GitHub Pages</h3><p>GitHub提供了一个Pages的服务，给广大薅羊毛用户:)创造了一个免费搭建静态网页博客的机会。只要你有github账号，就可以有一个对应的<code>&lt;username&gt;.github.io</code>专属域名，。默认情况下我们需要创建一个<code>&lt;username&gt;.github.io</code>的github项目，这个项目中的网页内容将会被自动呈现在<code>https://&lt;username&gt;.github.io</code>下。假设该项目中有一个<code>index.html</code>文件，内容是<code>Hello World</code>，打开对应的网址就会看到大大的<code>Hello World</code>字样。</p><h3 id="Hexo"><a href="#Hexo" class="headerlink" title="Hexo"></a>Hexo</h3><p>虽然GitHub提供了一个非常完美的静态文件托管服务，但是我们不能每次手写一通复杂的html，写点东西的小激情会很容易被耗损。也不能就是一个纯文本页面，那也太朴素了一点。这时候就需要类似<a href="https://hexo.io/zh-cn/">Hexo</a>这样的快速、简洁且高效的博客框架，可以很方便地将markdown渲染为一定样式的页面。</p><p>选中Hexo的主要原因是因为它有一套完整的markdown支持体系，除了一开始的配置之外，以后每次写文章只需要新建一个md文件就可以开写了，在书写过程中不需要再额外考虑样式等问题。</p><p>一个完整的Hexo项目都会包括以下几个部分，根目录下的<code>_config.yml</code>被称作为站点配置文件，<code>scaffolds</code>内存储的是页面的markdown模板，<code>themes</code>下存放主题插件（下一节里介绍），里面也会包含一个<code>_config.yml</code>被称之为主题配置文件，至于<code>source</code>里放的就是你写的markdown博文啦。</p><div class='spoiler collapsed'>    <div class='spoiler-title'>        站点配置文件 _config.yml    </div>    <div class='spoiler-content'>        <figure class="highlight yml"><figcaption><span>site_config</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Hexo Configuration</span></span><br><span class="line"><span class="comment">## Docs: https://hexo.io/docs/configuration.html</span></span><br><span class="line"><span class="comment">## Source: https://github.com/hexojs/hexo/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 站点基本信息配置</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">胡一刀的随笔</span></span><br><span class="line"><span class="attr">subtitle:</span> <span class="string">May</span> <span class="string">the</span> <span class="string">force</span> <span class="string">be</span> <span class="string">with</span> <span class="string">you</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">分享技术</span></span><br><span class="line"><span class="attr">keywords:</span> <span class="string">博客</span></span><br><span class="line"><span class="attr">author:</span> <span class="string">sonnyhcl</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">zh-CN</span></span><br><span class="line"><span class="attr">timezone:</span> <span class="string">Asia/Shanghai</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 站点域名配置</span></span><br><span class="line"><span class="comment">## If your site is put in a subdirectory, set url as &#x27;http://yoursite.com/child&#x27; and root as &#x27;/child/&#x27;</span></span><br><span class="line"><span class="attr">url:</span> <span class="string">https://sonnyhcl.com/</span></span><br><span class="line"><span class="attr">root:</span> <span class="string">/</span></span><br><span class="line"><span class="comment">## 很多博客都会选择在前面加上:year/:month/:day/:title/作为链接，个人喜好问题</span></span><br><span class="line"><span class="attr">permalink:</span> <span class="string">:title/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件夹配置</span></span><br><span class="line"><span class="attr">source_dir:</span> <span class="string">source</span></span><br><span class="line"><span class="attr">public_dir:</span> <span class="string">public</span></span><br><span class="line"><span class="attr">tag_dir:</span> <span class="string">tags</span></span><br><span class="line"><span class="attr">archive_dir:</span> <span class="string">archives</span></span><br><span class="line"><span class="attr">category_dir:</span> <span class="string">categories</span></span><br><span class="line"><span class="attr">code_dir:</span> <span class="string">downloads/code</span></span><br><span class="line"><span class="attr">i18n_dir:</span> <span class="string">:lang</span></span><br><span class="line"><span class="attr">skip_render:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 博文配置</span></span><br><span class="line"><span class="attr">new_post_name:</span> <span class="string">:year-:month-:day-:title.md</span> <span class="comment"># File name of new posts</span></span><br><span class="line"><span class="attr">default_layout:</span> <span class="string">post</span></span><br><span class="line"><span class="attr">titlecase:</span> <span class="literal">false</span> <span class="comment"># Transform title into titlecase</span></span><br><span class="line"><span class="attr">external_link:</span> <span class="literal">true</span> <span class="comment"># Open external links in new tab</span></span><br><span class="line"><span class="attr">filename_case:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">render_drafts:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">post_asset_folder:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">relative_link:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">future:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">highlight:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">line_number:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">auto_detect:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">tab_replace:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 主页配置</span></span><br><span class="line"><span class="comment"># path: Root path for your blogs index page. (default = &#x27;&#x27;)</span></span><br><span class="line"><span class="comment"># per_page: Posts displayed per page. (0 = disable pagination)</span></span><br><span class="line"><span class="comment"># order_by: Posts order. (Order by date descending by default)</span></span><br><span class="line"><span class="attr">index_generator:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">per_page:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">order_by:</span> <span class="string">-date</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 分类与标签</span></span><br><span class="line"><span class="attr">default_category:</span> <span class="string">Tech</span></span><br><span class="line"><span class="attr">category_map:</span></span><br><span class="line"><span class="attr">tag_map:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日期时间格式</span></span><br><span class="line"><span class="comment">## Hexo uses Moment.js to parse and display date</span></span><br><span class="line"><span class="comment">## You can customize the date format as defined in</span></span><br><span class="line"><span class="comment">## http://momentjs.com/docs/#/displaying/format/</span></span><br><span class="line"><span class="attr">date_format:</span> <span class="string">YYYY-MM-DD</span></span><br><span class="line"><span class="attr">time_format:</span> <span class="string">HH:mm:ss</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分页设置</span></span><br><span class="line"><span class="comment">## Set per_page to 0 to disable pagination</span></span><br><span class="line"><span class="attr">per_page:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">pagination_dir:</span> <span class="string">page</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 扩展插件</span></span><br><span class="line"><span class="comment">## Plugins: https://hexo.io/plugins/</span></span><br><span class="line"><span class="attr">Plugins:</span> <span class="string">hexo-generate-feed</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件：阅读时间估计</span></span><br><span class="line"><span class="attr">symbols_count_time:</span></span><br><span class="line">  <span class="attr">symbols:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">time:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">total_symbols:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">total_time:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主题选择</span></span><br><span class="line"><span class="comment">## Themes: https://hexo.io/themes/</span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">next</span></span><br></pre></td></tr></table></figure>    </div></div><h3 id="Next-Mist"><a href="#Next-Mist" class="headerlink" title="Next Mist"></a>Next Mist</h3><p>Hexo负责的是文件转换，而静态网页的样式在主题插件中定义。Next就是这样一个主题插件，目前NexT支持如下三种Scheme，本着简洁、朴素的原则，我最后挑选了<a href="https://theme-next.iissnan.com/getting-started.html#select-scheme"><code>Next Mist</code></a>作为博客的主题。</p><ul><li>Muse - 默认 Scheme，这是NexT最初的版本，黑白主调，大量留白</li><li>Mist - Muse的紧凑版本，整洁有序的单栏外观</li><li>Pisces - 双栏Scheme，小家碧玉似的清新</li></ul><p><img src="theme.png" alt="theme"></p><div class='spoiler collapsed'>    <div class='spoiler-title'>        主题配置文件 _config.yml    </div>    <div class='spoiler-content'>        <figure class="highlight yml"><figcaption><span>theme_config</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">这个配置文件实在是太长了，我就不复制过来污染眼睛了</span></span><br><span class="line">[<span class="string">themes_next_config.yml</span>]<span class="string">(https://github.com/sonnyhcl/sonnyhcl.github.io/blob/source/themes/next/_config.yml)</span></span><br></pre></td></tr></table></figure>    </div></div><h3 id="Travis-CI"><a href="#Travis-CI" class="headerlink" title="Travis CI"></a>Travis CI</h3><p>由Markdown文件自动生成静态文件并部署到GitHub Pages这个流程可以说是非常机械和重复的。虽然hexo也有一个deploy的功能，但是总归还是要手工操作一波。源文件放在source分支，生成的静态文件部署在master分支上，本着能自动绝不手动的原则，这里我们利用<a href="https://travis-ci.org/">Travis CI</a>来自动完成部署的步骤。</p><p>我们需要在travis上设置在配置文件中用到的四个环境变量，其中<code>$GITHUB_TOKEN</code>需要在GitHub申请一个<a href="https://github.com/settings/tokens">Personal Token</a>，<code>$CUSTOM_DOMAIN</code>是博客所在的域名（即<code>&lt;username&gt;.github.io</code>)，<code>$GIT_NAME</code>和<code>$GIT_EMAIL</code>则是你的github账户。当我们创建或者修改了博文并推送到source分支之后，travis会自动拉取并生成最新的静态内容并推送到master分支。</p><p><img src="travis.png" alt="travis"></p><div class='spoiler collapsed'>    <div class='spoiler-title'>        .travis.yml    </div>    <div class='spoiler-content'>        <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">node_js</span></span><br><span class="line"><span class="attr">node_js:</span> <span class="string">stable</span></span><br><span class="line"></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line">  <span class="attr">apt:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">yarn:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">directories:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">node_modules</span></span><br><span class="line"></span><br><span class="line"><span class="attr">before_install:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">yarn</span> <span class="string">global</span> <span class="string">add</span> <span class="string">hexo-cli</span></span><br><span class="line"></span><br><span class="line"><span class="attr">install:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">yarn</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hexo</span> <span class="string">clean</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hexo</span> <span class="string">generate</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 仅当source分支更新的时候触发</span></span><br><span class="line"><span class="attr">branches:</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">source</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署到GitHub Pages </span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">provider:</span> <span class="string">pages</span></span><br><span class="line">  <span class="attr">skip_cleanup:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 不保留历史，避免git repo体积过度膨胀</span></span><br><span class="line">  <span class="attr">keep-history:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">github_token:</span> <span class="string">$GITHUB_TOKEN</span></span><br><span class="line">  <span class="attr">fqdn:</span> <span class="string">$CUSTOM_DOMAIN</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">$GIT_NAME</span></span><br><span class="line">  <span class="attr">email:</span> <span class="string">$GIT_EMAIL</span></span><br><span class="line">  <span class="attr">verbose:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># hexo生成的静态文件在public文件夹中</span></span><br><span class="line">  <span class="attr">local_dir:</span> <span class="string">public</span></span><br><span class="line">  <span class="comment"># 部署到master分支</span></span><br><span class="line">  <span class="attr">target-branch:</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">on:</span></span><br><span class="line">    <span class="attr">branch:</span> <span class="string">source</span></span><br></pre></td></tr></table></figure>    </div></div><h2 id="常规操作"><a href="#常规操作" class="headerlink" title="常规操作"></a>常规操作</h2><h3 id="开发环境部署"><a href="#开发环境部署" class="headerlink" title="开发环境部署"></a>开发环境部署</h3><p>如果要在一台新电脑上写博文，那么要先配置一下开发环境，其实这一步完全可以参考前面的.travis.yml中的步骤来，本质上是相同的。</p><ul><li><p>首先确保你已经安装了<a href="https://github.com/nvm-sh/nvm">node</a>和<a href="https://yarnpkg.com/zh-Hans/docs/install#debian-stable">yarn</a>。</p></li><li><p>安装hexo</p></li></ul><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn <span class="meta">global</span> <span class="keyword">add</span> hexo-<span class="keyword">cli</span></span><br></pre></td></tr></table></figure><ul><li>安装package.json中依赖</li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn <span class="keyword">install</span></span><br></pre></td></tr></table></figure><ul><li>到这里就部署好你的本地开发环境了</li></ul><h3 id="一篇博文的诞生"><a href="#一篇博文的诞生" class="headerlink" title="一篇博文的诞生"></a>一篇博文的诞生</h3><ul><li>首先需要想好要写什么，想一个简短的题目</li></ul><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo <span class="built_in">new</span> <span class="built_in">create</span>-<span class="keyword">a</span>-<span class="built_in">new</span>-<span class="built_in">post</span></span><br></pre></td></tr></table></figure><ul><li>然后就会在source/_posts文件夹下生成一个<code>日期+标题</code>的文件夹和markdown文件，可以直接在markdown中引用同名文件夹下的图片素材，如下所示。</li></ul><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!<span class="selector-attr">[travis]</span>(travis.png)</span><br></pre></td></tr></table></figure><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="http://blog.codesfile.com/2017/12/16/HEXO+Github%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2">HEXO+Github搭建博客</a></li><li><a href="http://blog.codesfile.com/2017/12/16/HEXO%E6%90%AD%E9%85%8DNext%E4%B8%BB%E9%A2%98%E4%BF%AE%E6%94%B9%E5%8D%9A%E5%AE%A2/">HEXO搭配Next主题修改博客</a></li><li><a href="https://almostover.ru/2016-01/hexo-theme-next-test/">Next主题美化</a></li></ul><blockquote><p>样式一次搞定不存在的，每次看到别人博客里好玩的都会研究下怎么neng过来lol</p></blockquote><div class="note danger"><p>求助！！要怎么样才能实现下面这样的效果呢？spoiler+codeblock+include三级嵌套！！</p></div><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">spoiler</span> &quot;站点配置文件 _config.yml&quot; %&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="template-tag">&#123;% <span class="name">codeblock</span> site_config.yml lang:yml %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">include</span></span> _config.yml %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name">endcodeblock</span> %&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="template-tag">&#123;% <span class="name">endspoiler</span> %&#125;</span></span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;本着随便写点什么的想法，我开始搭建了这个博客站点。想着是越简单越好，越朴素越好，现成的GitHub Pages不用白不用，最好是能直接基于markdown就能生成页面，最终选择了GitHub Pages+Hexo+Next Mist+Travis CI的方案。&lt;/p&gt;</summary>
    
    
    
    <category term="Tech" scheme="https://sonnyhcl.com/categories/Tech/"/>
    
    
    <category term="Hexo" scheme="https://sonnyhcl.com/tags/Hexo/"/>
    
    <category term="Github Page" scheme="https://sonnyhcl.com/tags/Github-Page/"/>
    
    <category term="Next" scheme="https://sonnyhcl.com/tags/Next/"/>
    
    <category term="Mist" scheme="https://sonnyhcl.com/tags/Mist/"/>
    
  </entry>
  
  <entry>
    <title>oh-my-fishy-zsh配置</title>
    <link href="https://sonnyhcl.com/install-a-fishlike-zsh/"/>
    <id>https://sonnyhcl.com/install-a-fishlike-zsh/</id>
    <published>2019-04-26T16:46:50.000Z</published>
    <updated>2019-04-26T16:46:50.000Z</updated>
    
    <content type="html"><![CDATA[<p>都说普通青年用bash，装逼青年用zsh，文艺青年用fish。</p><p>fish是真的好用，但是它最大的问题是与bash不兼容，从而带来各种各样兼容性问题，折腾过fish的人都知道。而zsh有着可定制化的oh-my-zsh框架，同时又是兼容bash语法的，笔者在这里记录一下如何安装一个oh-my-fishy-zsh。</p><span id="more"></span><h2 id="前置环境安装"><a href="#前置环境安装" class="headerlink" title="前置环境安装"></a>前置环境安装</h2><h3 id="环境参数"><a href="#环境参数" class="headerlink" title="环境参数"></a>环境参数</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">clhu</span>@t<span class="number">5</span> ~&gt; uname -a</span><br><span class="line"><span class="attribute">Linux</span> t<span class="number">5</span> <span class="number">4</span>.<span class="number">15</span>.<span class="number">0</span>-<span class="number">48</span>-generic #<span class="number">51</span>~<span class="number">16</span>.<span class="number">04</span>.<span class="number">1</span>-Ubuntu SMP Fri Apr <span class="number">5</span> <span class="number">12</span>:<span class="number">01</span>:<span class="number">12</span> UTC <span class="number">2019</span> x<span class="number">86</span>_<span class="number">64</span> x<span class="number">86</span>_<span class="number">64</span> x<span class="number">86</span>_<span class="number">64</span> GNU/Linux</span><br><span class="line"><span class="attribute">clhu</span>@t<span class="number">5</span> ~&gt; lsb_release -a</span><br><span class="line"><span class="attribute">No</span> LSB modules are available.</span><br><span class="line"><span class="attribute">Distributor</span> ID:Ubuntu</span><br><span class="line"><span class="attribute">Description</span>:Ubuntu <span class="number">16</span>.<span class="number">04</span>.<span class="number">6</span> LTS</span><br><span class="line"><span class="attribute">Release</span>:<span class="number">16</span>.<span class="number">04</span></span><br><span class="line"><span class="attribute">Codename</span>:xenial</span><br></pre></td></tr></table></figure><h3 id="安装zsh"><a href="#安装zsh" class="headerlink" title="安装zsh"></a>安装zsh</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="builtin-name">get</span> install zsh curl git</span><br></pre></td></tr></table></figure><h2 id="安装oh-my-zsh"><a href="#安装oh-my-zsh" class="headerlink" title="安装oh-my-zsh"></a>安装<a href="https://github.com/robbyrussell/oh-my-zsh">oh-my-zsh</a></h2><blockquote><p>安装过程中会自动切换默认的shell为zsh</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -c <span class="string">&quot;<span class="subst">$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)</span>&quot;</span></span><br></pre></td></tr></table></figure><h2 id="自定义你的-zshrc"><a href="#自定义你的-zshrc" class="headerlink" title="自定义你的.zshrc"></a>自定义你的<a href="zshrc">.zshrc</a></h2><div class='spoiler collapsed'>    <div class='spoiler-title'>        .zshrc    </div>    <div class='spoiler-content'>        <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># If you come from bash you might have to change your $PATH.</span></span><br><span class="line"><span class="comment"># export PATH=$HOME/bin:/usr/local/bin:$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Path to your oh-my-zsh installation.</span></span><br><span class="line">  <span class="string">export</span> <span class="string">ZSH=&quot;/home/clhu/.oh-my-zsh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set name of the theme to load --- if set to &quot;random&quot;, it will</span></span><br><span class="line"><span class="comment"># load a random theme each time oh-my-zsh is loaded, in which case,</span></span><br><span class="line"><span class="comment"># to know which specific one was loaded, run: echo $RANDOM_THEME</span></span><br><span class="line"><span class="comment"># See https://github.com/robbyrussell/oh-my-zsh/wiki/Themes</span></span><br><span class="line"><span class="string">ZSH_THEME=&quot;fishy&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set list of themes to pick from when loading at random</span></span><br><span class="line"><span class="comment"># Setting this variable when ZSH_THEME=random will cause zsh to load</span></span><br><span class="line"><span class="comment"># a theme from this variable instead of looking in ~/.oh-my-zsh/themes/</span></span><br><span class="line"><span class="comment"># If set to an empty array, this variable will have no effect.</span></span><br><span class="line"><span class="comment"># ZSH_THEME_RANDOM_CANDIDATES=( &quot;robbyrussell&quot; &quot;agnoster&quot; )</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment the following line to use case-sensitive completion.</span></span><br><span class="line"><span class="comment"># CASE_SENSITIVE=&quot;true&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment the following line to use hyphen-insensitive completion.</span></span><br><span class="line"><span class="comment"># Case-sensitive completion must be off. _ and - will be interchangeable.</span></span><br><span class="line"><span class="comment"># HYPHEN_INSENSITIVE=&quot;true&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment the following line to disable bi-weekly auto-update checks.</span></span><br><span class="line"><span class="string">DISABLE_AUTO_UPDATE=&quot;true&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment the following line to change how often to auto-update (in days).</span></span><br><span class="line"><span class="comment"># export UPDATE_ZSH_DAYS=13</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment the following line to disable colors in ls.</span></span><br><span class="line"><span class="comment"># DISABLE_LS_COLORS=&quot;true&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment the following line to disable auto-setting terminal title.</span></span><br><span class="line"><span class="comment"># DISABLE_AUTO_TITLE=&quot;true&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment the following line to enable command auto-correction.</span></span><br><span class="line"><span class="comment"># ENABLE_CORRECTION=&quot;true&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment the following line to display red dots whilst waiting for completion.</span></span><br><span class="line"><span class="comment"># COMPLETION_WAITING_DOTS=&quot;true&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment the following line if you want to disable marking untracked files</span></span><br><span class="line"><span class="comment"># under VCS as dirty. This makes repository status check for large repositories</span></span><br><span class="line"><span class="comment"># much, much faster.</span></span><br><span class="line"><span class="comment"># DISABLE_UNTRACKED_FILES_DIRTY=&quot;true&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment the following line if you want to change the command execution time</span></span><br><span class="line"><span class="comment"># stamp shown in the history command output.</span></span><br><span class="line"><span class="comment"># You can set one of the optional three formats:</span></span><br><span class="line"><span class="comment"># &quot;mm/dd/yyyy&quot;|&quot;dd.mm.yyyy&quot;|&quot;yyyy-mm-dd&quot;</span></span><br><span class="line"><span class="comment"># or set a custom format using the strftime function format specifications,</span></span><br><span class="line"><span class="comment"># see &#x27;man strftime&#x27; for details.</span></span><br><span class="line"><span class="string">HIST_STAMPS=&quot;yyyy-mm-dd&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Would you like to use another custom folder than $ZSH/custom?</span></span><br><span class="line"><span class="comment"># ZSH_CUSTOM=/path/to/new-custom-folder</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Which plugins would you like to load?</span></span><br><span class="line"><span class="comment"># Standard plugins can be found in ~/.oh-my-zsh/plugins/*</span></span><br><span class="line"><span class="comment"># Custom plugins may be added to ~/.oh-my-zsh/custom/plugins/</span></span><br><span class="line"><span class="comment"># Example format: plugins=(rails git textmate ruby lighthouse)</span></span><br><span class="line"><span class="comment"># Add wisely, as too many plugins slow down shell startup.</span></span><br><span class="line"><span class="string">plugins=(</span></span><br><span class="line">        <span class="string">git</span></span><br><span class="line">        <span class="string">zsh-autosuggestions</span></span><br><span class="line">        <span class="string">zsh-syntax-highlighting</span></span><br><span class="line">        <span class="string">zsh-completions</span></span><br><span class="line">        <span class="string">z</span></span><br><span class="line">        <span class="string">history-substring-search</span></span><br><span class="line">        <span class="string">command-not-found</span></span><br><span class="line">        <span class="string">colored-man-pages</span></span><br><span class="line">        <span class="string">extract</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"></span><br><span class="line"><span class="string">source</span> <span class="string">$ZSH/oh-my-zsh.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User configuration</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># export MANPATH=&quot;/usr/local/man:$MANPATH&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You may need to manually set your language environment</span></span><br><span class="line"><span class="comment"># export LANG=en_US.UTF-8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Preferred editor for local and remote sessions</span></span><br><span class="line"><span class="comment"># if [[ -n $SSH_CONNECTION ]]; then</span></span><br><span class="line"><span class="comment">#   export EDITOR=&#x27;vim&#x27;</span></span><br><span class="line"><span class="comment"># else</span></span><br><span class="line"><span class="comment">#   export EDITOR=&#x27;mvim&#x27;</span></span><br><span class="line"><span class="comment"># fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Compilation flags</span></span><br><span class="line"><span class="comment"># export ARCHFLAGS=&quot;-arch x86_64&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ssh</span></span><br><span class="line"><span class="comment"># export SSH_KEY_PATH=&quot;~/.ssh/rsa_id&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set personal aliases, overriding those provided by oh-my-zsh libs,</span></span><br><span class="line"><span class="comment"># plugins, and themes. Aliases can be placed here, though oh-my-zsh</span></span><br><span class="line"><span class="comment"># users are encouraged to define aliases within the ZSH_CUSTOM folder.</span></span><br><span class="line"><span class="comment"># For a full list of active aliases, run `alias`.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Example aliases</span></span><br><span class="line"><span class="comment"># alias zshconfig=&quot;mate ~/.zshrc&quot;</span></span><br><span class="line"><span class="comment"># alias ohmyzsh=&quot;mate ~/.oh-my-zsh&quot;</span></span><br><span class="line"><span class="string">bindkey</span> <span class="string">&#x27;,&#x27;</span> <span class="string">autosuggest-accept</span></span><br><span class="line"></span><br><span class="line"><span class="string">alias</span> <span class="string">re=&quot;source</span> <span class="string">~/.zshrc&quot;</span></span><br></pre></td></tr></table></figure>    </div></div><blockquote><p>安装完oh-my-zsh的下一步就是自定义配置文件，下面罗列了一些模仿fish必备的插件</p></blockquote><h3 id="fishy主题"><a href="#fishy主题" class="headerlink" title="fishy主题"></a>fishy主题</h3><p>zsh主题选择<code>fishy</code>，可以模仿fish特有的路径简写模式。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ZSH_THEME</span>=<span class="string">&quot;fishy&quot;</span></span><br></pre></td></tr></table></figure><h3 id="插件清单"><a href="#插件清单" class="headerlink" title="插件清单"></a>插件清单</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">plugins=(</span><br><span class="line">        git</span><br><span class="line">        zsh-autosuggestions</span><br><span class="line">        zsh-<span class="keyword">syntax</span>-highlighting</span><br><span class="line">        zsh-completions</span><br><span class="line">        <span class="keyword">z</span></span><br><span class="line">        <span class="keyword">history</span>-substring-<span class="built_in">search</span></span><br><span class="line">        <span class="keyword">command</span>-not-found</span><br><span class="line">        colored-man-pages</span><br><span class="line">        extract</span><br><span class="line">)</span><br></pre></td></tr></table></figure><ul><li>git: 提示当前目录所在git仓库的状态的插件</li><li><a href="https://github.com/robbyrussell/oh-my-zsh/tree/master/plugins/z">z</a>: 可以无脑跳跃到历史记录中出现过的文件夹中</li><li><a href="https://github.com/robbyrussell/oh-my-zsh/blob/master/plugins/command-not-found">command-not-found</a>：会自动根据出错的命令，推荐该命令可能相关的包</li><li><a href="https://github.com/robbyrussell/oh-my-zsh/blob/master/plugins/colored-man-pages">colored-man-pages</a>： 给man page自动高亮，命令行神器</li><li><a href="https://github.com/robbyrussell/oh-my-zsh/tree/master/plugins/extract">extract</a>： 只需要一个<code>x</code>就可以解压任何压缩包，再也不需要手打<code>tar xfvz</code></li><li><a href="https://github.com/zsh-users/zsh-syntax-highlighting.git">zsh-syntax-highlighting</a>: 模仿fish命令行高亮的插件</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="regexp">//gi</span>thub.com<span class="regexp">/zsh-users/</span>zsh-syntax-highlighting.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span><span class="regexp">/plugins/</span>zsh-syntax-highlighting</span><br></pre></td></tr></table></figure><ul><li><a href="https://github.com/zsh-users/zsh-autosuggestions">zsh-autosuggestions</a>: 根据命令历史记录自动推荐和提示的插件</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="regexp">//gi</span>thub.com<span class="regexp">/zsh-users/</span>zsh-autosuggestions <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span><span class="regexp">/plugins/</span>zsh-autosuggestions</span><br></pre></td></tr></table></figure><ul><li><a href="https://github.com/zsh-users/zsh-completions">zsh-completions</a>: 自动命令补全，类似bash-completions功能的插件</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="regexp">//gi</span>thub.com<span class="regexp">/zsh-users/</span>zsh-completions <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span><span class="regexp">/plugins/</span>zsh-completions</span><br></pre></td></tr></table></figure><ul><li><a href="https://github.com/zsh-users/zsh-history-substring-search">history-substring-search</a>: 按住向上箭头可以搜索出现过该关键字的历史命令</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="regexp">//gi</span>thub.com<span class="regexp">/zsh-users/</span>zsh-history-substring-search <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span><span class="regexp">/plugins/</span>zsh-history-substring-search</span><br></pre></td></tr></table></figure><h2 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h2><p>配置完成之后的效果如下图所示</p><p><img src="zsh.png" alt="zsh"></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;都说普通青年用bash，装逼青年用zsh，文艺青年用fish。&lt;/p&gt;
&lt;p&gt;fish是真的好用，但是它最大的问题是与bash不兼容，从而带来各种各样兼容性问题，折腾过fish的人都知道。而zsh有着可定制化的oh-my-zsh框架，同时又是兼容bash语法的，笔者在这里记录一下如何安装一个oh-my-fishy-zsh。&lt;/p&gt;</summary>
    
    
    
    <category term="Tech" scheme="https://sonnyhcl.com/categories/Tech/"/>
    
    
    <category term="zsh" scheme="https://sonnyhcl.com/tags/zsh/"/>
    
    <category term="fish" scheme="https://sonnyhcl.com/tags/fish/"/>
    
    <category term="oh-my-zsh" scheme="https://sonnyhcl.com/tags/oh-my-zsh/"/>
    
  </entry>
  
  <entry>
    <title>常用国内加速镜像源配置</title>
    <link href="https://sonnyhcl.com/mirror-everything/"/>
    <id>https://sonnyhcl.com/mirror-everything/</id>
    <published>2019-03-12T11:41:39.000Z</published>
    <updated>2019-03-12T11:41:39.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文总结了linux下常见的各式下载站的国内加速镜像源配置，都是笔者平时拿到一台新电脑或者重装之后（lol）必做的事情之一。</p><span id="more"></span><h2 id="pip-mirror"><a href="#pip-mirror" class="headerlink" title="pip mirror"></a>pip mirror</h2><p>常用的pip国内镜像源有</p><ul><li>豆瓣：<a href="http://pypi.douban.com/simple/">http://pypi.douban.com/simple/</a></li><li>清华：<a href="https://pypi.tuna.tsinghua.edu.cn/simple">https://pypi.tuna.tsinghua.edu.cn/simple</a></li></ul><p>临时使用只需要在后面加上一行参数</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask -i https:<span class="regexp">//</span>pypi.tuna.tsinghua.edu.cn/simple   </span><br></pre></td></tr></table></figure><p>如果想要一劳永逸的话</p><blockquote><p>vim ~/.pip/pip.conf</p></blockquote><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">global</span>]  </span><br><span class="line"><span class="keyword">index</span>-url = https://pypi.tuna.tsinghua.edu.cn/simple  </span><br><span class="line">[install]  </span><br><span class="line"><span class="keyword">trusted</span>-host=pypi.tuna.tsinghua.edu.cn</span><br><span class="line"><span class="keyword">disable</span>-pip-<span class="keyword">version</span>-<span class="keyword">check</span> = <span class="keyword">true</span>  </span><br><span class="line">timeout = <span class="number">6000</span>    </span><br></pre></td></tr></table></figure><h2 id="npm-mirror"><a href="#npm-mirror" class="headerlink" title="npm mirror"></a>npm mirror</h2><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm config set registry https:<span class="comment">//registry.npm.taobao.org</span></span><br></pre></td></tr></table></figure><h2 id="docker-mirror"><a href="#docker-mirror" class="headerlink" title="docker mirror"></a>docker mirror</h2><blockquote><p><code>/etc/docker/daemon.json</code></p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://quay.mirrors.ustc.edu.cn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://gcr.mirrors.ustc.edu.cn&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="maven-mirror"><a href="#maven-mirror" class="headerlink" title="maven mirror"></a>maven mirror</h2><p>修改maven根目录下的conf文件夹中的setting.xml文件</p><blockquote><p><code>/home/whoami/.m2/settings.xml</code></p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-aliyun<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus aliyun<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/repositories/central<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>详细的设置参考也可以看<a href="https://mirrors.163.com/.help/maven.html">网易maven的镜像设置教程</a></li></ul><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文总结了linux下常见的各式下载站的国内加速镜像源配置，都是笔者平时拿到一台新电脑或者重装之后（lol）必做的事情之一。&lt;/p&gt;</summary>
    
    
    
    <category term="Tech" scheme="https://sonnyhcl.com/categories/Tech/"/>
    
    
    <category term="镜像源" scheme="https://sonnyhcl.com/tags/%E9%95%9C%E5%83%8F%E6%BA%90/"/>
    
    <category term="mirrors" scheme="https://sonnyhcl.com/tags/mirrors/"/>
    
    <category term="pip" scheme="https://sonnyhcl.com/tags/pip/"/>
    
    <category term="docker" scheme="https://sonnyhcl.com/tags/docker/"/>
    
    <category term="maven" scheme="https://sonnyhcl.com/tags/maven/"/>
    
    <category term="npm" scheme="https://sonnyhcl.com/tags/npm/"/>
    
  </entry>
  
</feed>
